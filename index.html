<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Avaliações</title>

    <!-- Ícones / Charts / PDF -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- DOCX (para exportar prova .docx) -->
    <script src="https://unpkg.com/docx@8.4.0/build/index.js"></script>

    <style>
      :root {
        --primary-color: #5a7dff;
        --secondary-color: #8faaff;
        --accent-color: #17c3b2;
        --text-color: #f0f2f5;
        --card-bg: rgba(30, 39, 50, 0.85);
        --success-color: #00b894;
        --danger-color: #ff6b6b;
        --form-color: #5a7dff;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      /* Fundo com sua imagem */
      body {
        min-height: 100vh;
        color: var(--text-color);
        background: linear-gradient(rgba(0, 0, 0, 0.55), rgba(0, 0, 0, 0.55)),
          url("assets/fundo-estrelado.png") center/cover no-repeat fixed;
        padding: 20px;
      }
      .wrap {
        max-width: 1200px;
        margin: 0 auto;
      }
      .glass {
        background: rgba(0, 0, 0, 0.45);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 18px;
        padding: 26px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(10px);
        color: #fff;
      }
      .title {
        font-size: 2.2rem;
        font-weight: 800;
        margin: 6px 0 4px;
        background: linear-gradient(to right, var(--secondary-color), #fff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        display: inline-block;
      }
      .subtitle {
        color: #d0d5ff;
        opacity: 0.9;
      }
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
        gap: 14px;
      }
      .badge {
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 0.9rem;
      }
      .btn {
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: transparent;
        color: #fff;
        padding: 10px 16px;
        border-radius: 10px;
        cursor: pointer;
      }
      .btn:hover {
        background: rgba(255, 255, 255, 0.06);
      }
      .btn.primary {
        background: var(--primary-color);
        border-color: transparent;
      }
      .btn.primary:hover {
        background: #6d8bff;
      }
      .actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      .screen {
        max-width: 980px;
        margin: 30px auto;
      }
      .hidden {
        display: none !important;
      }
      form {
        display: grid;
        gap: 16px;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      label {
        font-weight: 700;
        color: var(--secondary-color);
      }
      input,
      select,
      textarea {
        padding: 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.25);
        color: #fff;
        font-size: 1rem;
        outline: none;
      }
      a.link {
        color: #fff;
        text-decoration: underline;
      }

      header {
        text-align: center;
        margin-bottom: 24px;
        padding: 10px;
      }
      h1 {
        font-size: 2rem;
        margin-bottom: 8px;
        background: linear-gradient(
          to right,
          var(--primary-color),
          var(--accent-color)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        display: inline-block;
      }
      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }
      .card {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 22px;
        text-align: center;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        transition: 0.3s;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
      }
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
        background: rgba(40, 50, 60, 0.9);
      }
      .card.disabled {
        opacity: 0.6;
        pointer-events: none;
      }
      .card i {
        font-size: 2.6rem;
        margin-bottom: 12px;
      }
      .card h3 {
        font-size: 1.25rem;
        margin-bottom: 6px;
      }
      .card p {
        color: #dfe6e9;
        font-size: 0.92rem;
      }
      .section {
        display: none;
        background: var(--card-bg);
        border-radius: 15px;
        padding: 24px;
        margin-bottom: 22px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
      }
      .active {
        display: block;
        animation: fadeIn 0.4s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .back-btn {
        background: var(--primary-color);
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 999px;
        cursor: pointer;
        margin-bottom: 14px;
      }
      .back-btn:hover {
        background: var(--accent-color);
      }
      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 14px;
        flex-wrap: wrap;
      }
      .tab {
        padding: 10px 18px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        cursor: pointer;
      }
      .tab.active {
        background: var(--primary-color);
      }
      .chart-container {
        position: relative;
        height: 390px;
        margin-top: 6px;
      }
      .danger-btn {
        background: var(--danger-color);
      }
      .danger-btn:hover {
        background: #ff7675;
      }
      .student-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 10px;
      }
      .student-card {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 10px;
        border-left: 4px solid var(--accent-color);
      }
      .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        margin-top: 10px;
      }
      .status-correct {
        background: var(--success-color);
      }
      .status-wrong {
        background: var(--danger-color);
      }
      .ranking-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        overflow: hidden;
      }
      .ranking-table th,
      .ranking-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .ranking-table th {
        background: var(--primary-color);
        color: #fff;
      }
      .medal {
        display: inline-block;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        text-align: center;
        line-height: 25px;
        margin-right: 10px;
        font-weight: 700;
      }
      .gold {
        background: linear-gradient(145deg, #ffd700, #daa520);
        color: #000;
      }
      .silver {
        background: linear-gradient(145deg, #c0c0c0, #a9a9a9);
        color: #000;
      }
      .bronze {
        background: linear-gradient(145deg, #cd7f32, #8c6b46);
        color: #fff;
      }
      .student-count {
        margin: 10px 0;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        text-align: center;
      }
      .link-box {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 10px;
        margin: 10px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .link-box input {
        flex: 1;
        background: rgba(255, 255, 255, 0.1);
      }
      .copy-btn {
        background: var(--accent-color);
        padding: 10px 14px;
        border-radius: 8px;
        cursor: pointer;
      }
      .copy-btn:hover {
        background: var(--primary-color);
      }
      /* Banco de Questões */
      .qb-toolbar {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 10px;
        margin-bottom: 12px;
      }
      .qb-list {
        display: grid;
        gap: 10px;
      }
      .qb-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        padding: 12px;
      }
      .qb-head {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
      }
      .tag {
        display: inline-block;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 0.78rem;
      }
      .muted {
        opacity: 0.85;
      }
      .tiny {
        font-size: 0.86rem;
      }
      .builder-list {
        display: grid;
        gap: 8px;
      }
      .builder-item {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 10px;
        display: flex;
        gap: 10px;
        align-items: flex-start;
      }
      .builder-actions {
        display: flex;
        gap: 6px;
        margin-left: auto;
      }
      .pagination {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: flex-end;
        margin-top: 10px;
      }
      @media (max-width: 900px) {
        .qb-toolbar {
          grid-template-columns: 1fr 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <!-- HOME -->
      <section id="screen-home" class="screen">
        <div class="glass">
          <div
            style="
              display: flex;
              gap: 12px;
              align-items: center;
              margin-bottom: 10px;
            "
          >
            <i class="fa-solid fa-atom" style="font-size: 28px"></i>
            <span class="title">Física</span>
            <span class="subtitle">Sistema de Avaliações</span>
          </div>
          <p class="subtitle" style="margin-bottom: 16px">
            Gerencie avaliações, gabaritos e resultados.
          </p>
          <div class="actions">
            <button class="btn" onclick="switchAuth('signup')">Cadastro</button>
            <button class="btn primary" onclick="switchAuth('login')">
              Login
            </button>
          </div>
        </div>
      </section>

      <!-- AUTH -->
      <section id="screen-auth" class="screen hidden">
        <div class="glass">
          <div
            style="
              display: flex;
              gap: 12px;
              align-items: center;
              margin-bottom: 14px;
            "
          >
            <i class="fa-solid fa-atom" style="font-size: 28px"></i>
            <span class="title">Física</span>
            <span class="subtitle" id="auth-title">Login</span>
          </div>

          <!-- Login -->
          <form id="form-login">
            <div class="form-group">
              <label for="email">E-mail</label
              ><input
                id="email"
                type="email"
                placeholder="voce@exemplo.com"
                required
              />
            </div>
            <div class="form-group">
              <label for="password">Senha</label
              ><input
                id="password"
                type="password"
                placeholder="Sua senha"
                required
              />
            </div>
            <div class="actions">
              <button type="button" class="btn" onclick="go('home')">
                Voltar
              </button>
              <button class="btn primary">Entrar</button>
            </div>
            <p class="subtitle tiny" style="margin-top: 6px">
              Novo por aqui?
              <a
                href="#"
                class="link"
                onclick="switchAuth('signup');return false;"
                >Cadastre-se</a
              >
            </p>
          </form>

          <!-- Cadastro -->
          <form id="form-signup" class="hidden">
            <div class="form-group">
              <label for="name">Nome</label
              ><input
                id="name"
                type="text"
                placeholder="Seu nome completo"
                required
              />
            </div>
            <div class="form-group">
              <label for="email2">E-mail</label
              ><input
                id="email2"
                type="email"
                placeholder="voce@exemplo.com"
                required
              />
            </div>
            <div class="form-group">
              <label for="password2">Senha</label
              ><input
                id="password2"
                type="password"
                placeholder="Crie uma senha"
                required
              />
            </div>
            <div class="form-group">
              <label for="role2">Perfil</label>
              <select id="role2" required>
                <option value="aluno">Aluno</option>
                <option value="professor">Professor</option>
              </select>
            </div>
            <div class="actions">
              <button type="button" class="btn" onclick="go('home')">
                Voltar
              </button>
              <button class="btn primary">Cadastrar</button>
            </div>
            <p class="subtitle tiny" style="margin-top: 6px">
              Já tem conta?
              <a
                href="#"
                class="link"
                onclick="switchAuth('login');return false;"
                >Entrar</a
              >
            </p>
          </form>
        </div>
      </section>

      <!-- APP -->
      <section id="screen-app" class="hidden">
        <div class="topbar">
          <div style="display: flex; align-items: center; gap: 10px">
            <i class="fa-solid fa-atom"></i>
            <strong>Física • Sistema de Avaliações</strong>
            <span id="role-badge" class="badge">—</span>
          </div>
          <div class="actions">
            <button class="btn" onclick="logout()">Sair</button>
          </div>
        </div>

        <div class="container">
          <header>
            <h1><i class="fas fa-graduation-cap"></i> Sistema de Avaliações</h1>
            <p class="subtitle">
              Gerencie avaliações, gabaritos e resultados de forma eficiente
            </p>
          </header>

          <main>
            <!-- DASHBOARD -->
            <section id="dashboard" class="section active">
              <div class="dashboard">
                <div
                  class="card primary"
                  onclick="showSection('create-assessment')"
                  id="card-create-assessment"
                >
                  <i class="fas fa-plus-circle"></i>
                  <h3>Criar Avaliação</h3>
                  <p>Defina uma nova avaliação manualmente</p>
                </div>

                <div
                  class="card primary"
                  onclick="showSection('question-bank')"
                  id="card-question-bank"
                >
                  <i class="fa-solid fa-database"></i>
                  <h3>Banco de Questões</h3>
                  <p>Busque por ENEM/ITA/IME/Vestibulares</p>
                </div>

                <div
                  class="card primary"
                  onclick="showSection('exam-builder')"
                  id="card-exam-builder"
                >
                  <i class="fa-solid fa-list-check"></i>
                  <h3>Montar Prova</h3>
                  <p>Selecione questões e crie uma prova</p>
                </div>

                <div
                  id="card-insert-key"
                  class="card primary disabled"
                  onclick="showSection('insert-key')"
                >
                  <i class="fas fa-key"></i>
                  <h3>Inserir Gabarito</h3>
                  <p>Defina as respostas corretas</p>
                </div>

                <div
                  id="card-student-answers"
                  class="card primary disabled"
                  onclick="showSection('student-answers')"
                >
                  <i class="fas fa-user-graduate"></i>
                  <h3>Respostas dos Alunos</h3>
                  <p>Registre respostas (até 50)</p>
                </div>

                <div
                  id="card-results"
                  class="card primary disabled"
                  onclick="showSection('results')"
                >
                  <i class="fas fa-chart-bar"></i>
                  <h3>Resultados</h3>
                  <p>Análises por questão, assunto e aluno</p>
                </div>

                <div
                  id="card-manage-data"
                  class="card primary"
                  onclick="showSection('manage-data')"
                >
                  <i class="fas fa-database"></i>
                  <h3>Gerenciar Dados</h3>
                  <p>Apague todos os dados</p>
                </div>

                <div
                  id="card-export-pdf"
                  class="card disabled"
                  onclick="exportToPDF()"
                >
                  <i class="fas fa-file-pdf"></i>
                  <h3>Exportar PDF (Resultados)</h3>
                  <p>Relatório de desempenho</p>
                </div>

                <div
                  id="card-ranking"
                  class="card disabled"
                  onclick="showSection('ranking')"
                >
                  <i class="fas fa-trophy"></i>
                  <h3>Ranking da Turma</h3>
                  <p>Ordenado por desempenho</p>
                </div>

                <div
                  id="card-online-form"
                  class="card disabled"
                  onclick="showSection('online-form')"
                >
                  <i class="fas fa-file-alt"></i>
                  <h3>Formulário Online</h3>
                  <p>Avaliação no navegador</p>
                </div>
              </div>
            </section>

            <!-- CRIAR AVALIAÇÃO (manual) -->
            <section id="create-assessment" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fas fa-plus-circle"></i> Criar Nova Avaliação</h2>
              <form id="assessment-form">
                <div class="form-group">
                  <label for="assessment-name">Nome da Avaliação</label>
                  <input
                    id="assessment-name"
                    required
                    placeholder="Ex: Simulado 01"
                  />
                </div>
                <div class="form-group">
                  <label for="questions-count"
                    >Quantidade de Questões (1-50)</label
                  >
                  <input
                    type="number"
                    id="questions-count"
                    min="1"
                    max="50"
                    required
                  />
                </div>
                <div id="questions-container"></div>
                <button class="btn primary">Salvar Avaliação</button>
              </form>
            </section>

            <!-- BANCO DE QUESTÕES -->
            <section id="question-bank" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fa-solid fa-database"></i> Banco de Questões</h2>
              <div class="qb-toolbar">
                <input id="qb-search" placeholder="Buscar no enunciado..." />
                <input id="qb-subject" placeholder="Assunto (ex: Cinemática)" />
                <select id="qb-difficulty">
                  <option value="">Dificuldade</option>
                  <option>Fácil</option>
                  <option>Médio</option>
                  <option>Difícil</option>
                </select>
                <select id="qb-exam">
                  <option value="">Exame</option>
                  <option>ENEM</option>
                  <option>ITA</option>
                  <option>IME</option>
                  <option>VESTIBULAR</option>
                  <option>OUTRO</option>
                </select>
                <input id="qb-year" type="number" placeholder="Ano" />
                <input id="qb-tag" placeholder="Tag (ex: MRUV)" />
              </div>
              <div class="actions" style="margin-bottom: 10px">
                <button class="btn" onclick="qbClearFilters()">Limpar</button>
                <button class="btn primary" onclick="qbFetch(1)">Buscar</button>
              </div>
              <div
                id="qb-info"
                class="muted tiny"
                style="margin-bottom: 8px"
              ></div>
              <div id="qb-list" class="qb-list"></div>
              <div class="pagination">
                <button class="btn" onclick="qbPrev()">Anterior</button>
                <span id="qb-page-label" class="muted tiny">—</span>
                <button class="btn" onclick="qbNext()">Próxima</button>
              </div>
            </section>

            <!-- MONTAR PROVA -->
            <section id="exam-builder" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fa-solid fa-list-check"></i> Montar Prova</h2>
              <div class="form-group">
                <label for="builder-name">Nome da Prova</label>
                <input
                  id="builder-name"
                  placeholder="Ex: Simulado ENEM 2019 - Bloco 1"
                />
              </div>
              <div class="muted tiny" style="margin: 6px 0">
                Selecione questões no <strong>Banco de Questões</strong> e
                clique “Adicionar”. Elas aparecerão aqui.
              </div>
              <div id="builder-count" class="muted tiny">0 selecionadas</div>
              <div
                id="builder-list"
                class="builder-list"
                style="margin-top: 8px"
              ></div>
              <div class="actions" style="margin-top: 10px; flex-wrap: wrap">
                <button class="btn" onclick="builderClear()">
                  Limpar seleção
                </button>
                <button class="btn" onclick="builderExportPDF()">
                  Exportar Prova (PDF)
                </button>
                <button class="btn" onclick="builderExportDOCX()">
                  Exportar Prova (DOCX)
                </button>
                <button class="btn primary" onclick="builderCreateAssessment()">
                  Criar Avaliação
                </button>
              </div>
            </section>

            <!-- INSERIR GABARITO -->
            <section id="insert-key" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fas fa-key"></i> Inserir Gabarito</h2>
              <div id="key-container"></div>
              <button id="save-key-btn" class="btn primary">
                Salvar Gabarito
              </button>
            </section>

            <!-- RESPOSTAS ALUNOS -->
            <section id="student-answers" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fas fa-user-graduate"></i> Respostas dos Alunos</h2>
              <div class="student-count" id="student-count">
                Nenhum aluno cadastrado ainda. Máximo: 50 alunos.
              </div>
              <form id="student-form">
                <div class="form-group">
                  <label for="student-name">Nome do Aluno</label
                  ><input
                    id="student-name"
                    required
                    placeholder="Ex: João Silva"
                  />
                </div>
                <div id="answers-container"></div>
                <button class="btn primary">Salvar Respostas</button>
              </form>
              <div id="students-list-container" style="margin-top: 20px">
                <h3>Alunos Cadastrados</h3>
                <div id="students-list" class="student-list"></div>
              </div>
            </section>

            <!-- RESULTADOS -->
            <section id="results" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fas fa-chart-bar"></i> Resultados</h2>
              <div class="tabs">
                <div class="tab active" data-tab="question-tab">
                  Por Questão
                </div>
                <div class="tab" data-tab="subject-tab">Por Assunto</div>
                <div class="tab" data-tab="student-tab">Por Aluno</div>
              </div>
              <div id="question-tab" class="tab-content active">
                <div class="chart-container">
                  <canvas id="question-chart"></canvas>
                </div>
              </div>
              <div id="subject-tab" class="tab-content">
                <div class="chart-container">
                  <canvas id="subject-chart"></canvas>
                </div>
              </div>
              <div id="student-tab" class="tab-content">
                <div class="chart-container">
                  <canvas id="student-chart"></canvas>
                </div>
                <div id="student-details" style="margin-top: 18px"></div>
              </div>
            </section>

            <!-- RANKING -->
            <section id="ranking" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fas fa-trophy"></i> Ranking da Turma</h2>
              <div id="ranking-container"></div>
            </section>

            <!-- FORM ONLINE -->
            <section id="online-form" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fas fa-file-alt"></i> Formulário Online</h2>
              <div id="form-generator">
                <p>
                  Crie um formulário online para que seus alunos respondam
                  diretamente.
                </p>
                <div class="form-group">
                  <label for="form-title">Título do Formulário</label
                  ><input id="form-title" value="Avaliação Online" />
                </div>
                <div class="form-group">
                  <label for="form-description">Descrição/Instruções</label
                  ><textarea id="form-description" rows="3">
Preencha o formulário com suas respostas. Cada questão vale 1 ponto.</textarea
                  >
                </div>
                <div class="form-group">
                  <label for="form-require-name">Solicitar nome do aluno</label>
                  <select id="form-require-name">
                    <option value="yes">Sim</option>
                    <option value="no">Não</option>
                  </select>
                </div>
                <button id="generate-form-btn" class="btn primary">
                  Gerar Formulário Online
                </button>
                <div
                  id="form-link-container"
                  style="display: none; margin-top: 14px"
                >
                  <h3>Link do Formulário</h3>
                  <p>Compartilhe este link com seus alunos:</p>
                  <div class="link-box">
                    <input id="form-link" readonly />
                    <div class="copy-btn" onclick="copyFormLink()">
                      <i class="fas fa-copy"></i> Copiar
                    </div>
                  </div>
                  <div class="form-preview">
                    <h3>Pré-visualização</h3>
                    <div id="form-preview-container"></div>
                  </div>
                </div>
              </div>
            </section>

            <!-- GERENCIAR DADOS -->
            <section id="manage-data" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fas fa-database"></i> Gerenciamento de Dados</h2>
              <p>
                Apague todos os dados das avaliações, gabaritos e respostas dos
                alunos.
              </p>
              <button id="clear-data-btn" class="danger-btn btn">
                Apagar Todos os Dados
              </button>
              <div
                style="
                  margin-top: 16px;
                  padding: 12px;
                  background: rgba(0, 0, 0, 0.2);
                  border-radius: 10px;
                "
              >
                <h3>Status do Sistema</h3>
                <p id="status-assessment">Avaliação: Não configurada</p>
                <p id="status-key">Gabarito: Não definido</p>
                <p id="status-students">Alunos cadastrados: 0</p>
              </div>
            </section>
          </main>
        </div>
      </section>
    </div>

    <script>
      /* ===================== CONFIG ===================== */
      const API_URL = "https://api.fisicaava.online"; // em dev: "http://localhost:5000"

      /* ===================== AUX AUTH ===================== */
      const screenHome = document.getElementById("screen-home");
      const screenAuth = document.getElementById("screen-auth");
      const screenApp = document.getElementById("screen-app");
      const formLogin = document.getElementById("form-login");
      const formSignup = document.getElementById("form-signup");

      function go(where) {
        screenHome.classList.add("hidden");
        screenAuth.classList.add("hidden");
        screenApp.classList.add("hidden");
        if (where === "home") screenHome.classList.remove("hidden");
        if (where === "auth") screenAuth.classList.remove("hidden");
        if (where === "app") screenApp.classList.remove("hidden");
      }
      function switchAuth(mode) {
        go("auth");
        document.getElementById("auth-title").textContent =
          mode === "signup" ? "Cadastro" : "Login";
        formSignup.classList.toggle("hidden", mode !== "signup");
        formLogin.classList.toggle("hidden", mode !== "login");
      }
      function token() {
        return localStorage.getItem("token") || "";
      }
      function role() {
        return localStorage.getItem("role") || null;
      }
      function setRole(r) {
        localStorage.setItem("role", r);
        document.getElementById("role-badge").textContent = r
          ? r.toUpperCase()
          : "—";
      }
      function logout() {
        localStorage.clear();
        go("home");
      }
      async function authFetch(path, init = {}) {
        const headers = Object.assign(
          {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token()}`,
          },
          init.headers || {}
        );
        const res = await fetch(
          `${API_URL}${path}`,
          Object.assign({}, init, { headers })
        );
        return res;
      }

      function chooseRoleThenSave() {
        return new Promise((resolve) => {
          const overlay = document.createElement("div");
          overlay.style.cssText =
            "position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:9999";
          const box = document.createElement("div");
          box.className = "glass";
          box.style.maxWidth = "520px";
          box.innerHTML = `
          <h2 style="margin-top:0">Selecione seu perfil</h2>
          <p class="subtitle">Escolha para continuar</p>
          <div class="actions" style="gap:12px;margin-top:10px">
            <button class="btn primary" id="r-aluno">Sou Aluno</button>
            <button class="btn" id="r-prof">Sou Professor</button>
          </div>
          <div class="actions" style="margin-top:10px"><button class="btn" id="r-cancel">Cancelar</button></div>`;
          overlay.appendChild(box);
          document.body.appendChild(overlay);
          const done = (v) => {
            document.body.removeChild(overlay);
            resolve(v || null);
          };
          box.querySelector("#r-aluno").onclick = async () => {
            const ok = await saveRole("aluno");
            if (ok) done("aluno");
          };
          box.querySelector("#r-prof").onclick = async () => {
            const ok = await saveRole("professor");
            if (ok) done("professor");
          };
          box.querySelector("#r-cancel").onclick = () => done(null);
        });
      }
      async function saveRole(r) {
        try {
          const res = await authFetch("/me/role", {
            method: "POST",
            body: JSON.stringify({ role: r }),
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data?.error || "Não foi possível salvar o perfil");
            return false;
          }
          localStorage.setItem("user", JSON.stringify(data.user));
          return true;
        } catch (e) {
          console.error(e);
          alert("Erro ao salvar perfil");
          return false;
        }
      }

      /* ===================== ESTADO APP ===================== */
      let currentAssessment = null,
        answerKey = null,
        studentAnswers = [];
      let onlineFormLink = "";
      let questionChartInstance, subjectChartInstance, studentChartInstance;
      const questionsContainer = document.getElementById("questions-container");
      const keyContainer = document.getElementById("key-container");
      const answersContainer = document.getElementById("answers-container");
      const assessmentForm = document.getElementById("assessment-form");
      const studentForm = document.getElementById("student-form");
      const saveKeyBtn = document.getElementById("save-key-btn");
      const clearDataBtn = document.getElementById("clear-data-btn");
      const studentsList = document.getElementById("students-list");
      const studentCount = document.getElementById("student-count");
      const studentDetails = document.getElementById("student-details");
      const rankingContainer = document.getElementById("ranking-container");
      const generateFormBtn = document.getElementById("generate-form-btn");
      const formLinkContainer = document.getElementById("form-link-container");
      const formLink = document.getElementById("form-link");
      const formPreviewContainer = document.getElementById(
        "form-preview-container"
      );
      const tabButtons = document.querySelectorAll(".tab");

      // Banco de Questões
      let qbPage = 1,
        qbLimit = 10,
        qbTotal = 0,
        qbPages = 0;
      const qbEls = {
        search: document.getElementById("qb-search"),
        subject: document.getElementById("qb-subject"),
        difficulty: document.getElementById("qb-difficulty"),
        exam: document.getElementById("qb-exam"),
        year: document.getElementById("qb-year"),
        tag: document.getElementById("qb-tag"),
        list: document.getElementById("qb-list"),
        info: document.getElementById("qb-info"),
        label: document.getElementById("qb-page-label"),
      };

      // Builder
      let builderSelected = []; // array de questões inteiras
      const builderEls = {
        name: document.getElementById("builder-name"),
        list: document.getElementById("builder-list"),
        count: document.getElementById("builder-count"),
      };

      document.addEventListener("DOMContentLoaded", async () => {
        if (token()) {
          setRole(role());
          go("app");
          await initialize();
        } else {
          go("home");
        }
      });

      /* ===================== INIT ===================== */
      async function initialize() {
        const r = role();
        document.getElementById("role-badge").textContent = r
          ? r.toUpperCase()
          : "—";
        // Desabilitar cards do aluno
        const profOnly = [
          "card-create-assessment",
          "card-insert-key",
          "card-manage-data",
          "card-online-form",
          "card-question-bank",
          "card-exam-builder",
        ];
        profOnly.forEach((id) => {
          const el = document.getElementById(id);
          if (r === "aluno") el.classList.add("disabled");
          else el.classList.remove("disabled");
        });

        await fetchInitialData();
        updateDashboardCards();
        updateStatus();

        // listeners
        assessmentForm.onsubmit = handleAssessmentSubmit;
        studentForm.onsubmit = handleStudentSubmit;
        saveKeyBtn.onclick = handleSaveKey;
        clearDataBtn.onclick = handleClearData;
        generateFormBtn.onclick = generateOnlineForm;
        document.getElementById("questions-count").oninput =
          generateQuestionFields;
        tabButtons.forEach((tab) => (tab.onclick = handleTabClick));

        // Se professor, carregar banco inicialmente
        if (r === "professor") {
          qbFetch(1);
        }
      }

      async function fetchInitialData() {
        try {
          const res = await authFetch("/all-data");
          const data = await res.json();
          if (!res.ok) throw new Error(data?.error || "Falha ao carregar");
          currentAssessment = data.assessment;
          answerKey = data.answerKey;
          studentAnswers = data.studentAnswers || [];
        } catch (e) {
          console.error("Erro ao carregar dados iniciais:", e);
        }
      }

      /* ===================== NAVEGAÇÃO ===================== */
      function handleTabClick(ev) {
        const id = ev.target.getAttribute("data-tab");
        changeTab(id, ev.target);
      }
      function showSection(id) {
        document
          .querySelectorAll(".section")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        if (id === "insert-key") generateKeyFields();
        if (id === "student-answers") {
          generateAnswerFields();
          renderStudentsList();
          updateStudentCount();
        }
        if (id === "results") {
          renderQuestionChart();
          renderStudentDetails();
        }
        if (id === "ranking") renderRanking();
        if (id === "manage-data") updateStatus();
      }
      function changeTab(id, btn) {
        tabButtons.forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(id).classList.add("active");
        if (id === "question-tab") renderQuestionChart();
        if (id === "subject-tab") renderSubjectChart();
        if (id === "student-tab") {
          renderStudentChart();
          renderStudentDetails();
        }
      }

      function updateDashboardCards() {
        const cardsToDisable = {
          "card-insert-key": !currentAssessment,
          "card-student-answers": !currentAssessment || !answerKey,
          "card-results":
            !currentAssessment || !answerKey || studentAnswers.length === 0,
          "card-export-pdf":
            !currentAssessment || !answerKey || studentAnswers.length === 0,
          "card-ranking":
            !currentAssessment || !answerKey || studentAnswers.length === 0,
          "card-online-form": !currentAssessment || !answerKey,
        };
        for (const id in cardsToDisable) {
          const el = document.getElementById(id);
          if (cardsToDisable[id]) el.classList.add("disabled");
          else el.classList.remove("disabled");
        }
        if (role() === "aluno") {
          [
            "card-create-assessment",
            "card-insert-key",
            "card-manage-data",
            "card-online-form",
            "card-question-bank",
            "card-exam-builder",
          ].forEach((id) =>
            document.getElementById(id).classList.add("disabled")
          );
        }
      }
      function updateStatus() {
        document.getElementById(
          "status-assessment"
        ).textContent = `Avaliação: ${
          currentAssessment ? currentAssessment.name : "Não configurada"
        }`;
        document.getElementById("status-key").textContent = `Gabarito: ${
          answerKey ? "Definido" : "Não definido"
        }`;
        document.getElementById(
          "status-students"
        ).textContent = `Alunos cadastrados: ${studentAnswers.length}`;
      }

      /* ===================== CRIAR AVALIAÇÃO / GABARITO (manual) ===================== */
      function generateQuestionFields() {
        const n =
          parseInt(document.getElementById("questions-count").value) || 0;
        questionsContainer.innerHTML = "";
        for (let i = 1; i <= n; i++) {
          const d = document.createElement("div");
          d.className = "form-group";
          d.innerHTML = `<label for="question-${i}">Questão ${i} - Assunto</label><input id="question-${i}" required placeholder="Ex: Cinemática">`;
          questionsContainer.appendChild(d);
        }
      }
      async function handleAssessmentSubmit(e) {
        e.preventDefault();
        if (role() === "aluno") {
          alert("Apenas professores podem criar avaliações.");
          return;
        }
        const name = document.getElementById("assessment-name").value.trim();
        const n = parseInt(document.getElementById("questions-count").value);
        const questions = [];
        for (let i = 1; i <= n; i++) {
          const subject = document.getElementById(`question-${i}`).value.trim();
          if (!subject) {
            alert(`Preencha o assunto da questão ${i}.`);
            return;
          }
          questions.push({ number: i, subject });
        }
        try {
          const res = await authFetch("/assessments", {
            method: "POST",
            body: JSON.stringify({ name, questionsCount: n, questions }),
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data?.error || "Falha ao criar avaliação");
            return;
          }
          currentAssessment = data;
          alert("Avaliação salva!");
          updateDashboardCards();
          showSection("dashboard");
        } catch (err) {
          console.error(err);
          alert("Erro ao conectar");
        }
      }

      function generateKeyFields() {
        if (!currentAssessment) {
          keyContainer.innerHTML = "<p>Crie uma avaliação primeiro.</p>";
          return;
        }
        keyContainer.innerHTML =
          "<h3>Defina a alternativa correta para cada questão:</h3>";
        currentAssessment.questions.forEach((q) => {
          const d = document.createElement("div");
          d.className = "form-group";
          d.innerHTML = `<label for="key-${q.number}">Questão ${q.number} - ${q.subject}</label>
          <select id="key-${q.number}" required>
            <option value="">Selecione</option><option>A</option><option>B</option><option>C</option><option>D</option><option>E</option>
          </select>`;
          keyContainer.appendChild(d);
          if (answerKey) {
            const saved = answerKey.find((k) => k.questionNumber === q.number);
            if (saved)
              document.getElementById(`key-${q.number}`).value =
                saved.correctAnswer;
          }
        });
      }
      async function handleSaveKey() {
        if (role() === "aluno") {
          alert("Apenas professores podem salvar gabarito.");
          return;
        }
        if (!currentAssessment) {
          alert("Crie uma avaliação.");
          return;
        }
        const key = [];
        for (let i = 1; i <= currentAssessment.questionsCount; i++) {
          const v = document.getElementById(`key-${i}`).value;
          if (!v) {
            alert(`Selecione a alternativa da questão ${i}.`);
            return;
          }
          key.push({
            questionNumber: i,
            correctAnswer: v,
            subject: currentAssessment.questions.find((q) => q.number === i)
              .subject,
          });
        }
        try {
          const res = await authFetch("/answer-keys", {
            method: "POST",
            body: JSON.stringify({
              assessmentId: currentAssessment._id,
              answers: key,
            }),
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data?.error || "Falha ao salvar gabarito");
            return;
          }
          answerKey = data;
          alert("Gabarito salvo!");
          updateDashboardCards();
          showSection("dashboard");
        } catch (err) {
          console.error(err);
          alert("Erro ao conectar");
        }
      }

      /* ===================== RESPOSTAS ALUNOS ===================== */
      function generateAnswerFields() {
        if (!currentAssessment || !answerKey) {
          answersContainer.innerHTML =
            "<p>Crie a avaliação e defina o gabarito.</p>";
          return;
        }
        answersContainer.innerHTML = "<h3>Respostas do aluno:</h3>";
        currentAssessment.questions.forEach((q) => {
          const d = document.createElement("div");
          d.className = "form-group";
          d.innerHTML = `<label for="answer-${q.number}">Questão ${q.number} - ${q.subject}</label>
          <select id="answer-${q.number}" required><option value="">Selecione</option><option>A</option><option>B</option><option>C</option><option>D</option><option>E</option></select>`;
          answersContainer.appendChild(d);
        });
      }
      async function handleStudentSubmit(e) {
        e.preventDefault();
        if (studentAnswers.length >= 50) {
          alert("Limite de 50 alunos.");
          return;
        }
        const studentName = document
          .getElementById("student-name")
          .value.trim();
        if (
          studentAnswers.some(
            (s) => s.studentName.toLowerCase() === studentName.toLowerCase()
          )
        ) {
          alert("Aluno já cadastrado.");
          return;
        }
        const answers = [];
        for (let i = 1; i <= currentAssessment.questionsCount; i++) {
          const val = document.getElementById(`answer-${i}`).value;
          if (!val) {
            alert(`Selecione a alternativa da ${i}.`);
            return;
          }
          const isCorrect =
            val === answerKey.find((k) => k.questionNumber === i).correctAnswer;
          answers.push({
            questionNumber: i,
            answer: val,
            isCorrect,
            subject: currentAssessment.questions.find((q) => q.number === i)
              .subject,
          });
        }
        try {
          const res = await authFetch("/student-answers", {
            method: "POST",
            body: JSON.stringify({
              assessmentId: currentAssessment._id,
              studentName,
              answers,
            }),
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data?.error || "Falha ao salvar respostas");
            return;
          }
          studentAnswers.push(data);
          alert("Respostas salvas!");
          studentForm.reset();
          updateStudentCount();
          renderStudentsList();
          updateDashboardCards();
        } catch (err) {
          console.error(err);
          alert("Erro ao conectar");
        }
      }
      function renderStudentsList() {
        if (!currentAssessment || studentAnswers.length === 0) {
          studentsList.innerHTML = "<p>Nenhum aluno cadastrado.</p>";
          return;
        }
        studentsList.innerHTML = "";
        studentAnswers.forEach((st) => {
          const correct = st.answers.filter((a) => a.isCorrect).length;
          const total = currentAssessment.questionsCount;
          const score = (correct / total) * 100;
          const card = document.createElement("div");
          card.className = "student-card";
          card.innerHTML = `<h4>${
            st.studentName
          }</h4><p>Acertos: ${correct}/${total}</p><p>Nota: ${score.toFixed(
            1
          )}%</p>
          <span class="status-badge ${
            score >= 60 ? "status-correct" : "status-wrong"
          }">${score >= 60 ? "Aprovado" : "Reprovado"}</span>`;
          studentsList.appendChild(card);
        });
      }
      function updateStudentCount() {
        const msg = currentAssessment
          ? `Alunos cadastrados: ${studentAnswers.length}/50`
          : "Crie uma avaliação para registrar alunos.";
        studentCount.textContent = msg;
        if (studentAnswers.length >= 50)
          studentCount.innerHTML +=
            " - <strong>Limite máximo atingido</strong>";
      }

      /* ===================== LIMPEZA / EXPORT RESULTADOS / GRÁFICOS / RANKING ===================== */
      async function handleClearData() {
        if (role() === "aluno") {
          alert("Apenas professores podem limpar dados.");
          return;
        }
        if (confirm("Tem certeza que deseja apagar TODOS os dados?")) {
          try {
            const res = await authFetch("/clear-data", { method: "DELETE" });
            const data = await res.json();
            if (!res.ok) {
              alert(data?.error || "Falha ao limpar");
              return;
            }
            currentAssessment = null;
            answerKey = null;
            studentAnswers = [];
            onlineFormLink = "";
            alert("Dados apagados.");
            updateDashboardCards();
            updateStatus();
            showSection("dashboard");
            document.getElementById("assessment-form").reset();
            questionsContainer.innerHTML = "";
            keyContainer.innerHTML = "";
            answersContainer.innerHTML = "";
            studentsList.innerHTML = "";
            formLinkContainer.style.display = "none";
            formPreviewContainer.innerHTML = "";
            builderClear();
          } catch (err) {
            console.error(err);
            alert("Erro ao conectar");
          }
        }
      }

      function exportToPDF() {
        if (!currentAssessment || !answerKey || studentAnswers.length === 0) {
          alert("Não há dados para relatório.");
          return;
        }
        const el = document.createElement("div");
        el.style.padding = "20px";
        el.style.background = "#fff";
        el.style.color = "#000";
        el.style.fontFamily = "Arial,sans-serif";
        el.innerHTML = `<h1 style="text-align:center;color:${getComputedStyle(
          document.documentElement
        ).getPropertyValue("--primary-color")}">Relatório de Avaliação</h1>
        <h2>${
          currentAssessment.name
        }</h2><p><strong>Data:</strong> ${new Date().toLocaleDateString()}</p>
        <p><strong>Total de alunos:</strong> ${
          studentAnswers.length
        }</p><p><strong>Total de questões:</strong> ${
          currentAssessment.questionsCount
        }</p>`;
        document.body.appendChild(el);
        html2canvas(el).then((canvas) => {
          const imgData = canvas.toDataURL("image/png");
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF("p", "mm", "a4");
          const imgWidth = 210,
            pageHeight = 295;
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          let heightLeft = imgHeight,
            position = 0;
          pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
          while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }
          pdf.save(
            `relatorio-avaliacao-${currentAssessment.name
              .replace(/\s+/g, "-")
              .toLowerCase()}.pdf`
          );
          document.body.removeChild(el);
        });
      }

      function getTopStudents(limit) {
        return studentAnswers
          .map((s) => {
            const c = s.answers.filter((a) => a.isCorrect).length;
            return {
              studentName: s.studentName,
              correctAnswers: c,
              score: (c / currentAssessment.questionsCount) * 100,
            };
          })
          .sort((a, b) => b.score - a.score)
          .slice(0, limit);
      }
      function renderRanking() {
        if (!currentAssessment || !answerKey || studentAnswers.length === 0) {
          rankingContainer.innerHTML = "<p>Não há dados suficientes.</p>";
          return;
        }
        const top = getTopStudents(studentAnswers.length);
        rankingContainer.innerHTML = `<h3>Ranking de Desempenho</h3><table class="ranking-table"><thead><tr><th>Posição</th><th>Aluno</th><th>Nota</th><th>Acertos</th><th>Status</th></tr></thead><tbody>
        ${top
          .map((st, i) => {
            let medal =
              i === 0
                ? '<span class="medal gold">1º</span>'
                : i === 1
                ? '<span class="medal silver">2º</span>'
                : i === 2
                ? '<span class="medal bronze">3º</span>'
                : `<span>${i + 1}º</span>`;
            return `<tr><td>${medal}</td><td>${
              st.studentName
            }</td><td>${st.score.toFixed(1)}%</td><td>${st.correctAnswers}/${
              currentAssessment.questionsCount
            }</td>
          <td><span class="status-badge ${
            st.score >= 60 ? "status-correct" : "status-wrong"
          }">${st.score >= 60 ? "Aprovado" : "Reprovado"}</span></td></tr>`;
          })
          .join("")}</tbody></table>`;
      }

      function calculateQuestionPerformance() {
        return Array.from(
          { length: currentAssessment.questionsCount },
          (_, i) => {
            const num = i + 1;
            const correct = studentAnswers.filter(
              (s) => s.answers.find((a) => a.questionNumber === num)?.isCorrect
            ).length;
            const accuracy = (correct / studentAnswers.length) * 100;
            const subject = currentAssessment.questions.find(
              (q) => q.number === num
            ).subject;
            return { questionNumber: num, subject, accuracy };
          }
        );
      }
      function renderChart(canvasId, type, labels, data, opts) {
        const ctx = document.getElementById(canvasId).getContext("2d");
        let chart;
        if (canvasId === "question-chart") chart = questionChartInstance;
        if (canvasId === "subject-chart") chart = subjectChartInstance;
        if (canvasId === "student-chart") chart = studentChartInstance;
        if (chart) {
          chart.data.labels = labels;
          chart.data.datasets[0].data = data;
          chart.update();
        } else {
          const created = new Chart(ctx, {
            type,
            data: { labels, datasets: [{ data, ...opts }] },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              ...opts.options,
            },
          });
          if (canvasId === "question-chart") questionChartInstance = created;
          if (canvasId === "subject-chart") subjectChartInstance = created;
          if (canvasId === "student-chart") studentChartInstance = created;
        }
      }
      function renderQuestionChart() {
        if (!currentAssessment || studentAnswers.length === 0) {
          document.getElementById("question-tab").innerHTML =
            "<p>Sem dados.</p>";
          return;
        }
        const perf = calculateQuestionPerformance();
        const labels = perf.map((q) => `Q${q.questionNumber}`);
        const data = perf.map((q) => q.accuracy);
        renderChart("question-chart", "bar", labels, data, {
          label: "Taxa de Acerto (%)",
          backgroundColor: "rgba(90,125,255,.7)",
          borderColor: "rgba(90,125,255,1)",
          borderWidth: 1,
          options: {
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: { display: true, text: "Percentual" },
              },
            },
          },
        });
      }
      function renderSubjectChart() {
        if (!currentAssessment || studentAnswers.length === 0) {
          document.getElementById("subject-tab").innerHTML =
            "<p>Sem dados.</p>";
          return;
        }
        const subjects = [
          ...new Set(currentAssessment.questions.map((q) => q.subject)),
        ];
        const perf = subjects.map((s) => {
          const ans = studentAnswers.flatMap((st) =>
            st.answers.filter((a) => a.subject === s)
          );
          const c = ans.filter((a) => a.isCorrect).length;
          return (c / studentAnswers.length) * 100;
        });
        renderChart("subject-chart", "bar", subjects, perf, {
          label: "Desempenho por Assunto (%)",
          backgroundColor: [
            "rgba(90,125,255,.7)",
            "rgba(23,195,178,.7)",
            "rgba(252,203,87,.7)",
            "rgba(255,107,107,.7)",
          ],
          borderColor: [
            "rgba(90,125,255,1)",
            "rgba(23,195,178,1)",
            "rgba(252,203,87,1)",
            "rgba(255,107,107,1)",
          ],
          borderWidth: 1,
          options: {
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: { display: true, text: "Percentual" },
              },
            },
          },
        });
      }
      function renderStudentChart() {
        if (!currentAssessment || studentAnswers.length === 0) {
          document.getElementById("student-tab").innerHTML =
            "<p>Sem dados.</p>";
          return;
        }
        const arr = getTopStudents(studentAnswers.length);
        renderChart(
          "student-chart",
          "bar",
          arr.map((s) => s.studentName),
          arr.map((s) => s.score),
          {
            label: "Desempenho dos Alunos (%)",
            backgroundColor: "rgba(23,195,178,.7)",
            borderColor: "rgba(23,195,178,1)",
            borderWidth: 1,
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                  title: { display: true, text: "Percentual" },
                },
              },
            },
          }
        );
      }
      function renderStudentDetails() {
        if (!currentAssessment || studentAnswers.length === 0) {
          studentDetails.innerHTML = "<p>Sem dados.</p>";
          return;
        }
        studentDetails.innerHTML = "<h3>Detalhes por Aluno</h3>";
        studentAnswers.forEach((st) => {
          const correct = st.answers.filter((a) => a.isCorrect).length;
          const score = (correct / currentAssessment.questionsCount) * 100;
          const div = document.createElement("div");
          div.className = "student-card";
          div.style.marginBottom = "12px";
          let squares = "";
          for (let i = 1; i <= currentAssessment.questionsCount; i++) {
            const a = st.answers.find((x) => x.questionNumber === i);
            squares += `<div style="width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;background:${
              a?.isCorrect ? "var(--success-color)" : "var(--danger-color)"
            };font-size:.8rem">${i}</div>`;
          }
          div.innerHTML = `<h4>${st.studentName} - Nota: ${score.toFixed(
            1
          )}%</h4><p>Acertos: ${correct}/${currentAssessment.questionsCount}</p>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">${squares}</div>`;
          studentDetails.appendChild(div);
        });
      }

      /* ===================== FORM ONLINE ===================== */
      async function generateOnlineForm() {
        if (role() === "aluno") {
          alert("Apenas professores podem gerar formulário.");
          return;
        }
        if (!currentAssessment) {
          alert("Crie uma avaliação.");
          return;
        }
        if (!answerKey) {
          alert("Defina o gabarito.");
          return;
        }
        const title =
          document.getElementById("form-title").value || "Avaliação Online";
        const description =
          document.getElementById("form-description").value || "";
        const requireName =
          document.getElementById("form-require-name").value === "yes";
        try {
          const res = await authFetch("/forms", {
            method: "POST",
            body: JSON.stringify({
              assessmentId: currentAssessment._id,
              title,
              description,
              requireName,
            }),
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data?.error || "Falha ao criar formulário");
            return;
          }
          onlineFormLink = data.url;
          formLink.value = onlineFormLink;
          formLinkContainer.style.display = "block";
          renderFormPreview({ title, description, requireName });
          alert("Formulário criado!");
        } catch (e) {
          console.error(e);
          alert("Erro ao conectar");
        }
      }
      function renderFormPreview(fd) {
        if (!currentAssessment) return;
        formPreviewContainer.innerHTML = `<div style="background:rgba(255,255,255,.05);padding:14px;border-radius:10px">
          <h2>${fd.title}</h2><p>${fd.description || ""}</p>
          ${
            fd.requireName
              ? `<div class="form-group"><label>Nome do Aluno</label><input disabled placeholder="Digite seu nome"/></div>`
              : `<p><em>Envios anônimos habilitados.</em></p>`
          }
          <div>${currentAssessment.questions
            .map(
              (q) =>
                `<div class="question-preview" style="background:rgba(255,255,255,.05);padding:10px;border-radius:10px;margin:8px 0">
              <h4>Questão ${q.number} - ${q.subject}</h4>
              <div class="options-container">
                ${["A", "B", "C", "D", "E"]
                  .map(
                    (L) =>
                      `<div class="option-item"><input type="radio" disabled> <label>${L}</label></div>`
                  )
                  .join("")}
              </div>
            </div>`
            )
            .join("")}</div>
          <p style="margin-top:8px"><strong>Link público:</strong> <a href="${onlineFormLink}" target="_blank">${onlineFormLink}</a></p></div>`;
      }
      async function copyFormLink() {
        try {
          if (!onlineFormLink) return;
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(onlineFormLink);
          } else {
            formLink.select();
            document.execCommand("copy");
          }
          alert("Link copiado!");
        } catch {
          alert("Não foi possível copiar.");
        }
      }

      /* ===================== BANCO DE QUESTÕES ===================== */
      function qbBuildQuery(page) {
        const params = new URLSearchParams();
        if (qbEls.search.value.trim())
          params.set("search", qbEls.search.value.trim());
        if (qbEls.subject.value.trim())
          params.set("subject", qbEls.subject.value.trim());
        if (qbEls.difficulty.value)
          params.set("difficulty", qbEls.difficulty.value);
        if (qbEls.exam.value) params.set("exam", qbEls.exam.value);
        if (qbEls.year.value) params.set("year", qbEls.year.value);
        if (qbEls.tag.value.trim()) params.set("tag", qbEls.tag.value.trim());
        params.set("page", page || qbPage);
        params.set("limit", qbLimit);
        return params.toString();
      }
      async function qbFetch(page = 1) {
        if (role() === "aluno") {
          alert("Apenas professores.");
          return;
        }
        qbPage = page;
        try {
          qbEls.list.innerHTML = "<div class='muted tiny'>Carregando...</div>";
          const res = await authFetch(`/questions?${qbBuildQuery(page)}`);
          const data = await res.json();
          if (!res.ok) {
            qbEls.list.innerHTML = "<p>Falha ao carregar.</p>";
            return;
          }
          qbTotal = data.total || 0;
          qbPages = data.pages || 1;
          qbEls.info.textContent = `Total: ${qbTotal} | Página ${data.page} de ${qbPages}`;
          qbEls.label.textContent = `Página ${data.page} / ${qbPages}`;
          qbRenderList(data.items || []);
        } catch (e) {
          console.error(e);
          qbEls.list.innerHTML = "<p>Erro ao buscar.</p>";
        }
      }
      function qbRenderList(items) {
        if (!items.length) {
          qbEls.list.innerHTML = "<p>Nenhuma questão encontrada.</p>";
          return;
        }
        qbEls.list.innerHTML = "";
        items.forEach((q) => {
          const div = document.createElement("div");
          div.className = "qb-item";
          const meta = `<span class="tag">${q.exam || "—"} ${q.year || ""} ${
            q.questionCode ? "• " + q.questionCode : ""
          }</span>
                      <span class="tag">${q.subject || "Assunto"}</span>
                      <span class="tag">${q.difficulty || "Médio"}</span>
                      ${
                        Array.isArray(q.tags)
                          ? q.tags
                              .map((t) => `<span class="tag">${t}</span>`)
                              .join("")
                          : ""
                      }`;
          const opts = q.options
            ? Object.entries(q.options)
                .map(
                  ([k, v]) =>
                    `<div class="tiny"><strong>${k})</strong> ${v || ""}</div>`
                )
                .join("")
            : "";
          div.innerHTML = `
            <div class="qb-head">
              <div class="tiny muted">${meta}</div>
              <div class="actions">
                <button class="btn" onclick='builderAdd(${JSON.stringify(
                  q
                ).replace(/'/g, "&apos;")})'>Adicionar</button>
              </div>
            </div>
            <div style="margin-top:8px"><strong>Enunciado:</strong> <span class="muted">${
              q.statement
            }</span></div>
            <div style="margin-top:8px">${opts}</div>`;
          qbEls.list.appendChild(div);
        });
      }
      function qbPrev() {
        if (qbPage > 1) qbFetch(qbPage - 1);
      }
      function qbNext() {
        if (qbPage < qbPages) qbFetch(qbPage + 1);
      }
      function qbClearFilters() {
        qbEls.search.value = "";
        qbEls.subject.value = "";
        qbEls.difficulty.value = "";
        qbEls.exam.value = "";
        qbEls.year.value = "";
        qbEls.tag.value = "";
        qbFetch(1);
      }

      /* ===================== BUILDER (montar prova) ===================== */
      function builderSync() {
        builderEls.count.textContent = `${builderSelected.length} selecionadas`;
        builderEls.list.innerHTML = "";
        builderSelected.forEach((q, idx) => {
          const item = document.createElement("div");
          item.className = "builder-item";
          item.innerHTML = `<div style="min-width:36px"><strong>${
            idx + 1
          }.</strong></div>
            <div style="flex:1">
              <div class="tiny muted"><span class="tag">${q.exam || "—"} ${
            q.year || ""
          } ${q.questionCode ? "• " + q.questionCode : ""}</span>
              <span class="tag">${
                q.subject || "Assunto"
              }</span> <span class="tag">${q.difficulty || "Médio"}</span></div>
              <div style="margin-top:6px"><strong>Enunciado:</strong> ${
                q.statement
              }</div>
              <div style="margin-top:6px">${
                q.options
                  ? Object.entries(q.options)
                      .map(
                        ([k, v]) =>
                          `<div class="tiny"><strong>${k})</strong> ${
                            v || ""
                          }</div>`
                      )
                      .join("")
                  : ""
              }</div>
            </div>
            <div class="builder-actions">
              <button class="btn" title="Subir" onclick="builderMove(${idx},-1)"><i class="fa-solid fa-arrow-up"></i></button>
              <button class="btn" title="Descer" onclick="builderMove(${idx},1)"><i class="fa-solid fa-arrow-down"></i></button>
              <button class="btn danger-btn" title="Remover" onclick="builderRemove(${idx})"><i class="fa-solid fa-trash"></i></button>
            </div>`;
          builderEls.list.appendChild(item);
        });
      }
      function builderAdd(q) {
        if (builderSelected.find((x) => x._id === q._id)) {
          alert("Essa questão já foi adicionada.");
          return;
        }
        builderSelected.push(q);
        builderSync();
      }
      function builderRemove(i) {
        builderSelected.splice(i, 1);
        builderSync();
      }
      function builderMove(i, delta) {
        const j = i + delta;
        if (j < 0 || j >= builderSelected.length) return;
        const tmp = builderSelected[i];
        builderSelected[i] = builderSelected[j];
        builderSelected[j] = tmp;
        builderSync();
      }
      function builderClear() {
        builderSelected = [];
        builderSync();
      }

      async function builderCreateAssessment() {
        if (role() === "aluno") {
          alert("Apenas professores.");
          return;
        }
        if (builderSelected.length === 0) {
          alert("Adicione questões ao builder.");
          return;
        }
        const name = (
          builderEls.name.value || "Prova - Banco de Questões"
        ).trim();
        const ids = builderSelected.map((q) => q._id).filter(Boolean);
        if (ids.length !== builderSelected.length) {
          alert("Existem questões sem _id. Verifique se vieram do banco.");
          return;
        }
        try {
          const res = await authFetch("/assessments/from-bank", {
            method: "POST",
            body: JSON.stringify({ name, questionIds: ids }),
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data?.error || "Falha ao criar avaliação a partir do banco");
            return;
          }
          currentAssessment = data.assessment || data; // dependendo de como você implementou no server
          answerKey = data.answerKey || null;
          alert("Avaliação criada a partir do Banco!");
          updateDashboardCards();
          showSection("dashboard");
        } catch (e) {
          console.error(e);
          alert("Erro ao conectar");
        }
      }

      /* ===== Exportar Prova (PDF/DOCX) a partir do builder ===== */
      function builderExportPDF() {
        if (builderSelected.length === 0) {
          alert("Adicione questões ao builder.");
          return;
        }
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "mm", "a4");
        const margin = 15;
        let y = 20;
        const lineHeight = 7;
        const maxWidth = 180;
        const title = (builderEls.name.value || "Prova").trim();
        pdf.setFont("helvetica", "bold");
        pdf.setFontSize(16);
        pdf.text(title, 105, y, { align: "center" });
        y += 10;
        pdf.setFontSize(11);
        pdf.setFont("helvetica", "normal");
        builderSelected.forEach((q, idx) => {
          const num = idx + 1;
          const meta = [
            q.exam || "",
            q.year || "",
            q.questionCode || "",
            q.subject || "",
            q.difficulty || "",
          ]
            .filter(Boolean)
            .join(" • ");
          y = ensurePage(pdf, y, margin);
          pdf.setFont("helvetica", "bold");
          pdf.text(`${num}) ${meta}`, margin, y);
          y += 6;
          pdf.setFont("helvetica", "normal");
          y = wrapText(pdf, q.statement, margin, y, maxWidth, lineHeight);
          if (q.options) {
            ["A", "B", "C", "D", "E"].forEach((k) => {
              if (q.options[k]) {
                y = wrapText(
                  pdf,
                  `${k}) ${q.options[k]}`,
                  margin + 4,
                  y,
                  maxWidth - 4,
                  lineHeight
                );
              }
            });
          }
          y += 4;
        });
        pdf.save(`${title.replace(/\s+/g, "-").toLowerCase()}.pdf`);
      }
      function ensurePage(pdf, y, margin) {
        if (y > 280) {
          pdf.addPage();
          return margin;
        }
        return y;
      }
      function wrapText(pdf, text, x, y, maxWidth, lineHeight) {
        const lines = pdf.splitTextToSize(text || "", maxWidth);
        lines.forEach((line) => {
          y = ensurePage(pdf, y, 15);
          pdf.text(line, x, y);
          y += lineHeight;
        });
        return y;
      }

      async function builderExportDOCX() {
        if (builderSelected.length === 0) {
          alert("Adicione questões ao builder.");
          return;
        }
        const title = (builderEls.name.value || "Prova").trim();
        const docxNS = window.docx; // da CDN
        const paras = [
          new docxNS.Paragraph({
            text: title,
            heading: docxNS.HeadingLevel.HEADING_1,
          }),
        ];
        builderSelected.forEach((q, idx) => {
          const num = idx + 1;
          const meta = [
            q.exam || "",
            q.year || "",
            q.questionCode || "",
            q.subject || "",
            q.difficulty || "",
          ]
            .filter(Boolean)
            .join(" • ");
          paras.push(
            new docxNS.Paragraph({
              text: `${num}) ${meta}`,
              spacing: { after: 120 },
              bold: true,
            })
          );
          paras.push(
            new docxNS.Paragraph({
              text: q.statement || "",
              spacing: { after: 80 },
            })
          );
          if (q.options) {
            ["A", "B", "C", "D", "E"].forEach((k) => {
              if (q.options[k])
                paras.push(
                  new docxNS.Paragraph({
                    text: `${k}) ${q.options[k]}`,
                    spacing: { after: 40 },
                  })
                );
            });
          }
          paras.push(
            new docxNS.Paragraph({ text: "", spacing: { after: 160 } })
          );
        });
        const doc = new docxNS.Document({
          sections: [{ properties: {}, children: paras }],
        });
        const blob = await docxNS.Packer.toBlob(doc);
        downloadBlob(blob, `${title.replace(/\s+/g, "-").toLowerCase()}.docx`);
      }
      function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
