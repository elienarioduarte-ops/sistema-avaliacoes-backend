<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Avaliações</title>

    <!-- Libs existentes -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- ====== ESTILO ====== -->
    <style>
      /* =========================
       FUNDOS POR TELA (troque as imagens aqui)
    ==========================*/
      :root {
        --bg-home: url("assets/bg-home.jpg");
        --bg-auth: url("assets/bg-auth.jpg");
        --bg-profile: url("assets/bg-profile.jpg");
        --bg-app: url("assets/bg-app.jpg");
      }

      /* Layout de telas */
      .screen {
        min-height: 100dvh;
        display: grid;
        place-items: center;
        background-position: center;
        background-size: cover;
        background-attachment: fixed;
        padding: 20px;
      }
      .home {
        background: linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.25),
            rgba(0, 0, 0, 0.6)
          ),
          var(--bg-home) center/cover no-repeat fixed;
      }
      .auth {
        background: linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.35),
            rgba(0, 0, 0, 0.7)
          ),
          var(--bg-auth) center/cover no-repeat fixed;
      }
      .profile {
        background: linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.35),
            rgba(0, 0, 0, 0.7)
          ),
          var(--bg-profile) center/cover no-repeat fixed;
      }
      .app {
        background: linear-gradient(
            to bottom,
            rgba(0, 0, 0, 0.25),
            rgba(0, 0, 0, 0.55)
          ),
          var(--bg-app) center/cover no-repeat fixed;
      }

      .glass {
        width: min(92vw, 780px);
        padding: clamp(20px, 5vw, 40px);
        border-radius: 24px;
        background: rgba(0, 0, 0, 0.55);
        border: 1px solid rgba(255, 255, 255, 0.18);
        backdrop-filter: blur(10px);
        color: #f0f2f5;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
      }
      .actions {
        display: flex;
        gap: 14px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .btn {
        appearance: none;
        border-radius: 14px;
        padding: 14px 24px;
        font-weight: 700;
        font-size: 16px;
        border: 2px solid #fff;
        cursor: pointer;
        transition: 0.15s;
        min-width: 160px;
        color: #fff;
        background: transparent;
      }
      .btn.primary {
        background: #fff;
        color: #0a2a66;
        border-color: #fff;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
      }
      .btn:hover {
        transform: translateY(-2px);
      }
      .hidden {
        display: none !important;
      }

      /* Marca */
      .brand {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        margin-bottom: 14px;
      }
      .brand svg {
        width: 60px;
        height: 60px;
      }
      .brand .name {
        font-weight: 800;
        font-size: clamp(28px, 6vw, 44px);
        letter-spacing: 0.3px;
      }
      .subtitle {
        opacity: 0.95;
        font-weight: 600;
        margin: 0 0 18px;
        font-size: clamp(16px, 2.6vw, 20px);
      }

      /* ====== TEMA ORIGINAL (preservado) ====== */
      :root {
        --primary-color: #5a7dff;
        --secondary-color: #8faaff;
        --accent-color: #17c3b2;
        --text-color: #f0f2f5;
        --card-bg: rgba(30, 39, 50, 0.85);
        --hover-effect: rgba(90, 125, 255, 0.2);
        --success-color: #00b894;
        --danger-color: #ff6b6b;
        --warning-color: #feca57;
        --export-color: #00b894;
        --ranking-color: #feca57;
        --form-color: #5a7dff;
      }
      * {
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
      }
      h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        background: linear-gradient(
          to right,
          var(--primary-color),
          var(--accent-color)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        display: inline-block;
      }
      .subtitle-app {
        color: var(--secondary-color);
        font-size: 1.2rem;
      }

      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }
      .card {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        transition: transform 0.3s, box-shadow 0.3s, opacity 0.3s;
        cursor: pointer;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
        background: rgba(40, 50, 60, 0.9);
      }
      .card.disabled {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
      }
      .card i {
        font-size: 3rem;
        margin-bottom: 15px;
      }
      .card.primary i {
        color: var(--secondary-color);
      }
      .card.export i {
        color: var(--export-color);
      }
      .card.ranking i {
        color: var(--ranking-color);
      }
      .card.form i {
        color: var(--form-color);
      }
      .card h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
      }
      .card p {
        color: #dfe6e9;
        font-size: 0.9rem;
      }
      .section {
        display: none;
        background: var(--card-bg);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
      }
      .active {
        display: block;
        animation: fadeIn 0.5s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      h2 {
        font-size: 2rem;
        margin-bottom: 20px;
        color: var(--secondary-color);
      }
      .back-btn {
        background: var(--primary-color);
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 50px;
        cursor: pointer;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.3s;
      }
      .back-btn:hover {
        background: var(--accent-color);
      }
      form {
        display: grid;
        gap: 20px;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      label {
        font-weight: bold;
        color: var(--secondary-color);
      }
      input,
      select,
      textarea {
        padding: 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.2);
        color: var(--text-color);
        font-size: 1rem;
      }
      button {
        background: var(--primary-color);
        color: #fff;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        transition: background 0.3s, transform 0.2s;
      }
      button:hover {
        background: var(--accent-color);
        transform: translateY(-2px);
      }
      .question-item,
      .student-item {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
      }
      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .tab {
        padding: 10px 20px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
      }
      .tab.active {
        background: var(--primary-color);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .chart-container {
        position: relative;
        height: 400px;
        margin-top: 20px;
      }
      .danger-btn {
        background: var(--danger-color);
      }
      .danger-btn:hover {
        background: #ff7675;
      }
      .student-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }
      .student-card {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid var(--accent-color);
      }
      .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        margin-top: 10px;
      }
      .status-correct {
        background: var(--success-color);
      }
      .status-wrong {
        background: var(--danger-color);
      }
      .student-count {
        margin: 15px 0;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        text-align: center;
      }
      .ranking-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        overflow: hidden;
      }
      .ranking-table th,
      .ranking-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .ranking-table th {
        background: var(--primary-color);
        color: #fff;
      }
      .ranking-table tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
      }
      .ranking-table tr:nth-child(even) {
        background-color: rgba(0, 0, 0, 0.1);
      }
      .medal {
        display: inline-block;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        text-align: center;
        line-height: 25px;
        margin-right: 10px;
        font-weight: bold;
      }
      .gold {
        background: linear-gradient(145deg, #ffd700, #daa520);
        color: #000;
      }
      .silver {
        background: linear-gradient(145deg, #c0c0c0, #a9a9a9);
        color: #000;
      }
      .bronze {
        background: linear-gradient(145deg, #cd7f32, #8c6b46);
        color: #fff;
      }
      .link-box {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .link-box input {
        flex: 1;
        background: rgba(255, 255, 255, 0.1);
      }
      .copy-btn {
        background: var(--accent-color);
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
      }
      .copy-btn:hover {
        background: var(--primary-color);
      }
      .form-preview {
        background: rgba(0, 0, 0, 0.2);
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
      }
      .question-preview {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
      }
      .options-container {
        display: grid;
        gap: 10px;
        margin-top: 10px;
      }
      .option-item {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      @media (max-width: 768px) {
        .dashboard {
          grid-template-columns: 1fr;
        }
        .tabs {
          flex-direction: column;
        }
        .student-list {
          grid-template-columns: 1fr;
        }
        .link-box {
          flex-direction: column;
        }
      }
    </style>
  </head>

  <body>
    <!-- =========================
       TELA 1 — HOME
  ==========================-->
    <section id="home" class="screen home">
      <div class="glass" style="text-align: center">
        <div class="brand">
          <!-- Ícone átomo -->
          <svg viewBox="0 0 64 64" fill="none" aria-hidden="true">
            <circle cx="32" cy="32" r="5" fill="white" />
            <ellipse
              cx="32"
              cy="32"
              rx="22"
              ry="10"
              stroke="white"
              stroke-width="3"
            />
            <ellipse
              cx="32"
              cy="32"
              rx="10"
              ry="22"
              stroke="white"
              stroke-width="3"
            />
            <path
              d="M10 20c9 7 35 7 44 0"
              stroke="white"
              stroke-width="3"
              stroke-linecap="round"
            />
            <path
              d="M10 44c9-7 35-7 44 0"
              stroke="white"
              stroke-width="3"
              stroke-linecap="round"
            />
          </svg>
          <div class="name">Física</div>
        </div>
        <p class="subtitle">Seus estudos na palma da mão</p>
        <div class="actions">
          <button class="btn primary" onclick="go('auth','login')">
            Login
          </button>
          <button class="btn" onclick="go('auth','signup')">Cadastro</button>
        </div>
      </div>
    </section>

    <!-- =========================
       TELA 2 — LOGIN/CADASTRO
  ==========================-->
    <section id="auth" class="screen auth hidden">
      <div class="glass">
        <div class="brand" style="margin: 0 0 8px 0">
          <svg viewBox="0 0 64 64" fill="none" aria-hidden="true">
            <circle cx="32" cy="32" r="5" fill="white" />
            <ellipse
              cx="32"
              cy="32"
              rx="22"
              ry="10"
              stroke="white"
              stroke-width="3"
            />
            <ellipse
              cx="32"
              cy="32"
              rx="10"
              ry="22"
              stroke="white"
              stroke-width="3"
            />
          </svg>
          <div class="name" style="font-size: 28px">Física</div>
          <span id="authModeTag" class="subtitle" style="margin-left: 8px"
            >Login</span
          >
        </div>

        <!-- Form Login -->
        <form id="form-login" autocomplete="on">
          <div class="form-group">
            <label for="email">E-mail</label>
            <input
              id="email"
              type="email"
              placeholder="voce@exemplo.com"
              required
            />
          </div>
          <div class="form-group">
            <label for="password">Senha</label>
            <input
              id="password"
              type="password"
              placeholder="••••••••"
              required
            />
          </div>
          <div class="actions" style="justify-content: flex-end">
            <button type="button" class="btn" onclick="go('home')">
              Voltar
            </button>
            <button class="btn primary">Entrar</button>
          </div>
          <p class="subtitle" style="font-size: 14px; margin-top: 8px">
            Não tem conta?
            <a
              href="#"
              onclick="switchAuth('signup');return false;"
              style="color: #fff; text-decoration: underline"
              >Cadastre-se</a
            >
          </p>
        </form>

        <!-- Form Cadastro -->
        <form id="form-signup" class="hidden" autocomplete="on">
          <div class="form-group">
            <label for="name">Nome</label>
            <input
              id="name"
              type="text"
              placeholder="Seu nome completo"
              required
            />
          </div>
          <div class="form-group">
            <label for="email2">E-mail</label>
            <input
              id="email2"
              type="email"
              placeholder="voce@exemplo.com"
              required
            />
          </div>
          <div class="form-group">
            <label for="password2">Senha</label>
            <input
              id="password2"
              type="password"
              placeholder="Crie uma senha"
              required
            />
          </div>
          <div class="actions" style="justify-content: flex-end">
            <button type="button" class="btn" onclick="go('home')">
              Voltar
            </button>
            <button class="btn primary">Cadastrar</button>
          </div>
          <p class="subtitle" style="font-size: 14px; margin-top: 8px">
            Já tem conta?
            <a
              href="#"
              onclick="switchAuth('login');return false;"
              style="color: #fff; text-decoration: underline"
              >Entrar</a
            >
          </p>
        </form>
      </div>
    </section>

    <!-- =========================
       TELA 3 — SELEÇÃO DE PERFIL
  ==========================-->
    <section id="profile" class="screen profile hidden">
      <div class="glass">
        <h2 style="margin: 0 0 8px">Selecione seu perfil</h2>
        <p class="subtitle">
          Isso define o que você pode acessar dentro do sistema
        </p>
        <div
          class="actions"
          style="gap: 20px; margin-top: 12px; flex-wrap: wrap"
        >
          <button class="btn primary" onclick="setRole('aluno')">
            Sou Aluno
          </button>
          <button class="btn" onclick="setRole('professor')">
            Sou Professor
          </button>
        </div>
        <div class="actions" style="margin-top: 16px">
          <button class="btn" onclick="logout()">Sair</button>
        </div>
      </div>
    </section>

    <!-- =========================
       TELA 4 — APP (Áreas por perfil)
  ==========================-->
    <section id="app" class="screen app hidden">
      <!-- ======= ÁREA DO ALUNO ======= -->
      <div id="student-area" class="glass hidden">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
          "
        >
          <h2 style="margin: 0">Área do Aluno</h2>
          <div style="display: flex; gap: 10px">
            <button class="btn" onclick="go('profile')">Trocar perfil</button>
            <button class="btn" onclick="logout()">Sair</button>
          </div>
        </div>
        <p class="subtitle" id="who-student"></p>

        <div class="actions" style="justify-content: flex-start">
          <a class="btn primary" id="btn-form-publico" href="#" target="_blank"
            >Abrir Formulário da Avaliação</a
          >
        </div>

        <div style="margin-top: 16px; opacity: 0.9">
          <p>
            Você terá acesso apenas às suas respostas e resultados quando
            disponíveis.
          </p>
        </div>
      </div>

      <!-- ======= ÁREA DO PROFESSOR (SEU SISTEMA ORIGINAL) ======= -->
      <div id="professor-area" class="glass">
        <div class="container">
          <header>
            <h1><i class="fas fa-graduation-cap"></i> Sistema de Avaliações</h1>
            <p class="subtitle-app">
              Gerencie avaliações, gabaritos e resultados de forma eficiente
            </p>
            <div
              class="actions"
              style="justify-content: flex-end; margin-top: 10px"
            >
              <button class="btn" onclick="go('profile')">Trocar perfil</button>
              <button class="btn" onclick="logout()">Sair</button>
            </div>
            <p
              class="subtitle-app"
              id="who-professor"
              style="margin-top: 8px; opacity: 0.8"
            ></p>
          </header>

          <main>
            <!-- ====== DASHBOARD ====== -->
            <section id="dashboard" class="section active">
              <div class="dashboard">
                <div
                  class="card primary"
                  onclick="showSection('create-assessment')"
                >
                  <i class="fas fa-plus-circle"></i>
                  <h3>Criar Avaliação</h3>
                  <p>
                    Defina uma nova avaliação com nome, quantidade de questões e
                    assuntos
                  </p>
                </div>

                <div
                  id="card-insert-key"
                  class="card primary disabled"
                  onclick="showSection('insert-key')"
                >
                  <i class="fas fa-key"></i>
                  <h3>Inserir Gabarito</h3>
                  <p>
                    Defina as respostas corretas para cada questão da avaliação
                  </p>
                </div>

                <div
                  id="card-student-answers"
                  class="card primary disabled"
                  onclick="showSection('student-answers')"
                >
                  <i class="fas fa-user-graduate"></i>
                  <h3>Respostas dos Alunos</h3>
                  <p>
                    Registre as respostas dos alunos para cada questão (até 50
                    alunos)
                  </p>
                </div>

                <div
                  id="card-results"
                  class="card primary disabled"
                  onclick="showSection('results')"
                >
                  <i class="fas fa-chart-bar"></i>
                  <h3>Resultados</h3>
                  <p>
                    Visualize análises detalhadas por questão, assunto e aluno
                  </p>
                </div>

                <div
                  id="card-manage-data"
                  class="card primary"
                  onclick="showSection('manage-data')"
                >
                  <i class="fas fa-database"></i>
                  <h3>Gerenciar Dados</h3>
                  <p>Apague todos os dados para iniciar uma nova avaliação</p>
                </div>

                <div
                  id="card-export-pdf"
                  class="card export disabled"
                  onclick="exportToPDF()"
                >
                  <i class="fas fa-file-pdf"></i>
                  <h3>Exportar PDF</h3>
                  <p>
                    Gere um relatório completo em PDF com todos os dados da
                    avaliação
                  </p>
                </div>

                <div
                  id="card-ranking"
                  class="card ranking disabled"
                  onclick="showSection('ranking')"
                >
                  <i class="fas fa-trophy"></i>
                  <h3>Ranking da Turma</h3>
                  <p>
                    Visualize o ranking completo de alunos ordenados por
                    desempenho
                  </p>
                </div>

                <div
                  id="card-online-form"
                  class="card form disabled"
                  onclick="showSection('online-form')"
                >
                  <i class="fas fa-file-alt"></i>
                  <h3>Formulário Online</h3>
                  <p>
                    Crie uma avaliação online para os alunos responderem
                    diretamente no navegador
                  </p>
                </div>
              </div>
            </section>

            <!-- ====== SEÇÕES ====== -->
            <section id="create-assessment" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fas fa-plus-circle"></i> Criar Nova Avaliação</h2>
              <form id="assessment-form">
                <div class="form-group">
                  <label for="assessment-name">Nome da Avaliação</label>
                  <input
                    type="text"
                    id="assessment-name"
                    required
                    placeholder="Ex: Projeto Integrador - Módulo 1"
                  />
                </div>
                <div class="form-group">
                  <label for="questions-count"
                    >Quantidade de Questões (1-50)</label
                  >
                  <input
                    type="number"
                    id="questions-count"
                    min="1"
                    max="50"
                    required
                  />
                </div>
                <div id="questions-container"></div>
                <button type="submit">Salvar Avaliação</button>
              </form>
            </section>

            <section id="insert-key" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fas fa-key"></i> Inserir Gabarito</h2>
              <div id="key-container"></div>
              <button id="save-key-btn">Salvar Gabarito</button>
            </section>

            <section id="student-answers" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fas fa-user-graduate"></i> Respostas dos Alunos</h2>
              <div class="student-count" id="student-count">
                Nenhum aluno cadastrado ainda. Máximo: 50 alunos.
              </div>
              <form id="student-form">
                <div class="form-group">
                  <label for="student-name">Nome do Aluno</label>
                  <input
                    type="text"
                    id="student-name"
                    required
                    placeholder="Ex: João Silva"
                  />
                </div>
                <div id="answers-container"></div>
                <button type="submit">Salvar Respostas</button>
              </form>
              <div id="students-list-container" style="margin-top: 30px">
                <h3>Alunos Cadastrados</h3>
                <div id="students-list" class="student-list"></div>
              </div>
            </section>

            <section id="results" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fas fa-chart-bar"></i> Resultados</h2>
              <div class="tabs">
                <div class="tab active" data-tab="question-tab">
                  Por Questão
                </div>
                <div class="tab" data-tab="subject-tab">Por Assunto</div>
                <div class="tab" data-tab="student-tab">Por Aluno</div>
              </div>
              <div id="question-tab" class="tab-content active">
                <h3>Desempenho por Questão</h3>
                <div class="chart-container">
                  <canvas id="question-chart"></canvas>
                </div>
              </div>
              <div id="subject-tab" class="tab-content">
                <h3>Desempenho por Assunto</h3>
                <div class="chart-container">
                  <canvas id="subject-chart"></canvas>
                </div>
              </div>
              <div id="student-tab" class="tab-content">
                <h3>Desempenho por Aluno</h3>
                <div class="chart-container">
                  <canvas id="student-chart"></canvas>
                </div>
                <div id="student-details" style="margin-top: 30px"></div>
              </div>
            </section>

            <section id="ranking" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fas fa-trophy"></i> Ranking da Turma</h2>
              <div id="ranking-container"></div>
            </section>

            <section id="online-form" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fas fa-file-alt"></i> Formulário Online</h2>
              <div id="form-generator">
                <p>
                  Crie um formulário online para que seus alunos possam
                  responder a avaliação diretamente pelo navegador.
                </p>
                <div class="form-group">
                  <label for="form-title">Título do Formulário</label>
                  <input
                    type="text"
                    id="form-title"
                    placeholder="Ex: Avaliação de Matemática"
                    value="Avaliação Online"
                  />
                </div>
                <div class="form-group">
                  <label for="form-description">Descrição/Instruções</label>
                  <textarea
                    id="form-description"
                    rows="3"
                    placeholder="Digite as instruções para os alunos"
                  >
Preencha o formulário com suas respostas. Cada questão vale 1 ponto.</textarea
                  >
                </div>
                <div class="form-group">
                  <label for="form-require-name">Solicitar nome do aluno</label>
                  <select id="form-require-name">
                    <option value="yes">Sim</option>
                    <option value="no">Não</option>
                  </select>
                </div>
                <button id="generate-form-btn">Gerar Formulário Online</button>
                <div
                  id="form-link-container"
                  style="display: none; margin-top: 20px"
                >
                  <h3>Link do Formulário</h3>
                  <p>Compartilhe este link com seus alunos:</p>
                  <div class="link-box">
                    <input type="text" id="form-link" readonly />
                    <div class="copy-btn" onclick="copyFormLink()">
                      <i class="fas fa-copy"></i> Copiar
                    </div>
                  </div>
                  <div class="form-preview">
                    <h3>Pré-visualização do Formulário</h3>
                    <div id="form-preview-container"></div>
                  </div>
                </div>
              </div>
            </section>

            <section id="manage-data" class="section">
              <button class="back-btn" onclick="showSection('dashboard')">
                <i class="fas fa-arrow-left"></i> Voltar
              </button>
              <h2><i class="fas fa-database"></i> Gerenciamento de Dados</h2>
              <p>
                Esta ação irá apagar todos os dados das avaliações, gabaritos e
                respostas dos alunos.
              </p>
              <p>Tem certeza que deseja continuar?</p>
              <button id="clear-data-btn" class="danger-btn">
                Apagar Todos os Dados
              </button>
              <div
                style="
                  margin-top: 30px;
                  padding: 15px;
                  background: rgba(0, 0, 0, 0.2);
                  border-radius: 8px;
                "
              >
                <h3>Status do Sistema</h3>
                <p id="status-assessment">Avaliação: Não configurada</p>
                <p id="status-key">Gabarito: Não definido</p>
                <p id="status-students">Alunos cadastrados: 0</p>
              </div>
            </section>
          </main>
        </div>
      </div>
    </section>

    <!-- =========================
       SCRIPTS
  ==========================-->
    <script>
      /* ========= Helpers de API com JWT ========= */
      const API_URL = "https://api.fisicaava.online";
      function getToken() {
        return localStorage.getItem("token");
      }
      async function authFetch(path, options = {}) {
        const token = getToken();
        const headers = {
          "Content-Type": "application/json",
          ...(options.headers || {}),
          ...(token ? { Authorization: `Bearer ${token}` } : {}),
        };
        const res = await fetch(`${API_URL}${path}`, { ...options, headers });
        return res;
      }

      // ====== VARS DO APP ======
      let currentAssessment = null;
      let answerKey = null; // array de {questionNumber, correctAnswer, subject}
      let studentAnswers = [];
      let onlineFormLink = "";
      let questionChartInstance, subjectChartInstance, studentChartInstance;

      // ====== ELEMENTOS (app) ======
      const questionsContainer = document.getElementById("questions-container");
      const keyContainer = document.getElementById("key-container");
      const answersContainer = document.getElementById("answers-container");
      const assessmentForm = document.getElementById("assessment-form");
      const studentForm = document.getElementById("student-form");
      const saveKeyBtn = document.getElementById("save-key-btn");
      const clearDataBtn = document.getElementById("clear-data-btn");
      const studentsList = document.getElementById("students-list");
      const studentCount = document.getElementById("student-count");
      const studentDetails = document.getElementById("student-details");
      const rankingContainer = document.getElementById("ranking-container");
      const generateFormBtn = document.getElementById("generate-form-btn");
      const formLinkContainer = document.getElementById("form-link-container");
      const formLink = document.getElementById("form-link");
      const formPreviewContainer = document.getElementById(
        "form-preview-container"
      );
      const tabButtons = document.querySelectorAll(".tab");

      // ====== ELEMENTOS (telas novas) ======
      const authModeTag = document.getElementById("authModeTag");
      const formLogin = document.getElementById("form-login");
      const formSignup = document.getElementById("form-signup");
      const whoStudent = document.getElementById("who-student");
      const whoProfessor = document.getElementById("who-professor");
      const studentArea = document.getElementById("student-area");
      const professorArea = document.getElementById("professor-area");
      const btnFormPublico = document.getElementById("btn-form-publico");

      // ====== NAVEGAÇÃO DE TELAS ======
      function go(screen, mode) {
        for (const s of document.querySelectorAll(".screen"))
          s.classList.add("hidden");
        document.getElementById(screen).classList.remove("hidden");
        if (screen === "auth") switchAuth(mode || "login");
        if (screen === "app") paintApp();
        window.scrollTo({ top: 0, behavior: "instant" });
      }
      function switchAuth(mode) {
        if (mode === "signup") {
          formLogin.classList.add("hidden");
          formSignup.classList.remove("hidden");
          authModeTag.textContent = "Cadastro";
        } else {
          formSignup.classList.add("hidden");
          formLogin.classList.remove("hidden");
          authModeTag.textContent = "Login";
        }
      }

      // ====== LOGIN REAL ======
      formLogin.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("email").value.trim();
        const pass = document.getElementById("password").value;

        try {
          const res = await fetch(`${API_URL}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password: pass }),
          });
          const data = await res.json();

          if (!res.ok) {
            alert(data?.message || data?.error || "Falha no login");
            return;
          }
          // Esperado: { token, user: { name?, email, role? } }
          localStorage.setItem("token", data.token);
          localStorage.setItem("user", JSON.stringify(data.user || { email }));

          if (data.user?.role === "professor" || data.user?.role === "aluno") {
            localStorage.setItem("role", data.user.role);
            go("app");
          } else {
            go("profile");
          }
        } catch (err) {
          console.error(err);
          alert("Erro ao conectar com o servidor.");
        }
      });

      // ====== CADASTRO REAL ======
      formSignup.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("name").value.trim();
        const email = document.getElementById("email2").value.trim();
        const pass = document.getElementById("password2").value;

        try {
          const res = await fetch(`${API_URL}/auth/signup`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, email, password: pass }),
          });
          const data = await res.json();

          if (!res.ok) {
            alert(data?.message || data?.error || "Erro no cadastro");
            return;
          }

          localStorage.setItem("token", data.token);
          localStorage.setItem(
            "user",
            JSON.stringify(data.user || { name, email })
          );

          if (data.user?.role === "professor" || data.user?.role === "aluno") {
            localStorage.setItem("role", data.user.role);
            go("app");
          } else {
            go("profile");
          }
        } catch (err) {
          console.error(err);
          alert("Erro ao conectar com o servidor.");
        }
      });

      function setRole(role) {
        localStorage.setItem("role", role); // 'aluno' | 'professor'
        go("app");
      }
      function paintApp() {
        const user = JSON.parse(localStorage.getItem("user") || "{}");
        const role = localStorage.getItem("role") || "aluno";

        btnFormPublico.href = onlineFormLink || "#";
        btnFormPublico.classList.toggle("hidden", !onlineFormLink);

        if (role === "professor") {
          studentArea.classList.add("hidden");
          professorArea.classList.remove("hidden");
          whoProfessor.textContent = `Logado como PROFESSOR — ${
            user.name || user.email || "Usuário"
          }`;
        } else {
          professorArea.classList.add("hidden");
          studentArea.classList.remove("hidden");
          whoStudent.textContent = `Logado como ALUNO — ${
            user.name || user.email || "Usuário"
          }`;
        }
      }
      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        localStorage.removeItem("role");
        go("home");
      }

      // ====== INICIALIZAÇÃO ======
      document.addEventListener("DOMContentLoaded", () => {
        bootAuth();
        initializeApp();
      });

      function bootAuth() {
        const token = localStorage.getItem("token");
        const role = localStorage.getItem("role");
        if (!token) {
          go("home");
          return;
        }
        if (!role) {
          go("profile");
          return;
        }
        go("app");
      }

      async function initializeApp() {
        await fetchInitialData();
        updateDashboardCards();
        updateStatus();

        document
          .getElementById("assessment-form")
          .addEventListener("submit", handleAssessmentSubmit);
        document
          .getElementById("student-form")
          .addEventListener("submit", handleStudentSubmit);
        document
          .getElementById("save-key-btn")
          .addEventListener("click", handleSaveKey);
        document
          .getElementById("clear-data-btn")
          .addEventListener("click", handleClearData);
        document
          .getElementById("generate-form-btn")
          .addEventListener("click", generateOnlineForm);
        document
          .getElementById("questions-count")
          .addEventListener("input", generateQuestionFields);
        tabButtons.forEach((tab) =>
          tab.addEventListener("click", handleTabClick)
        );
      }

      // --- Carregar dados iniciais (AGORA com token) ---
      async function fetchInitialData() {
        try {
          const response = await authFetch("/all-data");
          if (!response.ok)
            throw new Error("Não foi possível carregar os dados.");
          const data = await response.json();
          currentAssessment = data.assessment;
          answerKey = data.answerKey;
          studentAnswers = data.studentAnswers || [];
        } catch (error) {
          console.error("Erro ao carregar dados iniciais:", error);
        }
      }

      // ====== (restante do app original) ======
      function handleTabClick(event) {
        const tabId = event.target.getAttribute("data-tab");
        changeTab(tabId, event.target);
      }
      function showSection(sectionId) {
        const sections = document.querySelectorAll(".section");
        sections.forEach((section) => section.classList.remove("active"));
        document.getElementById(sectionId).classList.add("active");

        if (sectionId === "insert-key") generateKeyFields();
        if (sectionId === "student-answers") {
          generateAnswerFields();
          renderStudentsList();
          updateStudentCount();
        }
        if (sectionId === "results") {
          renderQuestionChart();
          renderStudentDetails();
        }
        if (sectionId === "ranking") renderRanking();
        if (sectionId === "manage-data") updateStatus();
      }
      function changeTab(tabId, clickedTab) {
        tabButtons.forEach((tab) => tab.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));
        clickedTab.classList.add("active");
        document.getElementById(tabId).classList.add("active");
        if (tabId === "question-tab") renderQuestionChart();
        if (tabId === "subject-tab") renderSubjectChart();
        if (tabId === "student-tab") {
          renderStudentChart();
          renderStudentDetails();
        }
      }
      function updateDashboardCards() {
        const cardsToDisable = {
          "card-insert-key": !currentAssessment,
          "card-student-answers": !currentAssessment || !answerKey,
          "card-results":
            !currentAssessment || !answerKey || studentAnswers.length === 0,
          "card-export-pdf":
            !currentAssessment || !answerKey || studentAnswers.length === 0,
          "card-ranking":
            !currentAssessment || !answerKey || studentAnswers.length === 0,
          "card-online-form": !currentAssessment || !answerKey,
        };
        for (const id in cardsToDisable) {
          const card = document.getElementById(id);
          if (!card) continue;
          cardsToDisable[id]
            ? card.classList.add("disabled")
            : card.classList.remove("disabled");
        }
      }
      function updateStatus() {
        document.getElementById(
          "status-assessment"
        ).textContent = `Avaliação: ${
          currentAssessment ? currentAssessment.name : "Não configurada"
        }`;
        document.getElementById("status-key").textContent = `Gabarito: ${
          answerKey ? "Definido" : "Não definido"
        }`;
        document.getElementById(
          "status-students"
        ).textContent = `Alunos cadastrados: ${studentAnswers.length}`;
      }

      // === Avaliação e gabarito
      function generateQuestionFields() {
        const questionsCount =
          parseInt(document.getElementById("questions-count").value) || 0;
        questionsContainer.innerHTML = "";
        for (let i = 1; i <= questionsCount; i++) {
          const questionDiv = document.createElement("div");
          questionDiv.className = "form-group";
          questionDiv.innerHTML = `
          <label for="question-${i}">Questão ${i} - Assunto</label>
          <input type="text" id="question-${i}" required placeholder="Ex: Matemática Básica">
        `;
          questionsContainer.appendChild(questionDiv);
        }
      }
      async function handleAssessmentSubmit(e) {
        e.preventDefault();
        const assessmentName = document.getElementById("assessment-name").value;
        const questionsCount = parseInt(
          document.getElementById("questions-count").value
        );
        const questions = [];
        for (let i = 1; i <= questionsCount; i++) {
          const subject = document.getElementById(`question-${i}`).value.trim();
          if (!subject) {
            alert(`Preencha o assunto da questão ${i}.`);
            return;
          }
          questions.push({ number: i, subject });
        }
        const assessmentData = {
          name: assessmentName,
          questionsCount,
          questions,
        };
        try {
          const response = await authFetch("/assessments", {
            method: "POST",
            body: JSON.stringify(assessmentData),
          });
          const newAssessment = await response.json();
          if (response.ok) {
            currentAssessment = newAssessment;
            alert("Avaliação salva com sucesso!");
            updateDashboardCards();
            showSection("dashboard");
          } else {
            alert(`Erro: ${newAssessment.error || "Falha ao criar avaliação"}`);
          }
        } catch (error) {
          alert("Erro ao conectar com o servidor.");
          console.error(error);
        }
      }
      function generateKeyFields() {
        if (!currentAssessment) {
          keyContainer.innerHTML =
            '<p>Primeiro crie uma avaliação na seção "Criar Avaliação".</p>';
          return;
        }
        keyContainer.innerHTML =
          "<h3>Defina a alternativa correta para cada questão:</h3>";
        currentAssessment.questions.forEach((question) => {
          const keyDiv = document.createElement("div");
          keyDiv.className = "form-group";
          keyDiv.innerHTML = `
          <label for="key-${question.number}">Questão ${question.number} - ${question.subject}</label>
          <select id="key-${question.number}" required>
            <option value="">Selecione a alternativa correta</option>
            <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option>
          </select>`;
          keyContainer.appendChild(keyDiv);
          if (answerKey) {
            const savedKey = answerKey.find(
              (k) => k.questionNumber === question.number
            );
            if (savedKey)
              document.getElementById(`key-${question.number}`).value =
                savedKey.correctAnswer;
          }
        });
      }
      async function handleSaveKey() {
        if (!currentAssessment) {
          alert("Primeiro crie uma avaliação.");
          return;
        }
        const key = [];
        for (let i = 1; i <= currentAssessment.questionsCount; i++) {
          const correctAnswer = document.getElementById(`key-${i}`).value;
          if (!correctAnswer) {
            alert(`Selecione a alternativa correta para a questão ${i}.`);
            return;
          }
          key.push({
            questionNumber: i,
            correctAnswer,
            subject: currentAssessment.questions.find((q) => q.number === i)
              .subject,
          });
        }
        const keyData = { assessmentId: currentAssessment._id, answers: key };
        try {
          const response = await authFetch("/answer-keys", {
            method: "POST",
            body: JSON.stringify(keyData),
          });
          const newKey = await response.json();
          if (response.ok) {
            answerKey = newKey;
            alert("Gabarito salvo com sucesso!");
            updateDashboardCards();
            showSection("dashboard");
          } else {
            alert(`Erro: ${newKey.error || "Falha ao salvar gabarito"}`);
          }
        } catch (error) {
          alert("Erro ao conectar com o servidor.");
          console.error(error);
        }
      }

      // === Respostas dos alunos
      function generateAnswerFields() {
        if (!currentAssessment || !answerKey) {
          answersContainer.innerHTML =
            "<p>Crie uma avaliação e defina o gabarito primeiro.</p>";
          return;
        }
        answersContainer.innerHTML =
          "<h3>Respostas do aluno para cada questão:</h3>";
        currentAssessment.questions.forEach((question) => {
          const answerDiv = document.createElement("div");
          answerDiv.className = "form-group";
          answerDiv.innerHTML = `
          <label for="answer-${question.number}">Questão ${question.number} - ${question.subject}</label>
          <select id="answer-${question.number}" required>
            <option value="">Selecione a alternativa</option>
            <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option>
          </select>`;
          answersContainer.appendChild(answerDiv);
        });
      }
      async function handleStudentSubmit(e) {
        e.preventDefault();
        if (studentAnswers.length >= 50) {
          alert("Limite máximo de 50 alunos atingido.");
          return;
        }
        const studentName = document
          .getElementById("student-name")
          .value.trim();
        if (
          studentAnswers.some(
            (s) => s.studentName.toLowerCase() === studentName.toLowerCase()
          )
        ) {
          alert("Já existe um aluno com este nome.");
          return;
        }
        const answers = [];
        for (let i = 1; i <= currentAssessment.questionsCount; i++) {
          const answer = document.getElementById(`answer-${i}`).value;
          if (!answer) {
            alert(`Selecione uma alternativa para a questão ${i}.`);
            return;
          }
          const isCorrect =
            answer ===
            answerKey.find((k) => k.questionNumber === i).correctAnswer;
          answers.push({
            questionNumber: i,
            answer,
            isCorrect,
            subject: currentAssessment.questions.find((q) => q.number === i)
              .subject,
          });
        }
        const studentData = {
          assessmentId: currentAssessment._id,
          studentName,
          answers,
        };
        try {
          const response = await authFetch("/student-answers", {
            method: "POST",
            body: JSON.stringify(studentData),
          });
          const newStudent = await response.json();
          if (response.ok) {
            studentAnswers.push(newStudent);
            alert("Respostas do aluno salvas com sucesso!");
            studentForm.reset();
            updateStudentCount();
            renderStudentsList();
            updateDashboardCards();
          } else {
            alert(`Erro: ${newStudent.error || "Falha ao salvar respostas"}`);
          }
        } catch (error) {
          alert("Erro ao conectar com o servidor.");
          console.error(error);
        }
      }
      function renderStudentsList() {
        if (!currentAssessment || studentAnswers.length === 0) {
          studentsList.innerHTML = "<p>Nenhum aluno cadastrado ainda.</p>";
          return;
        }
        studentsList.innerHTML = "";
        studentAnswers.forEach((student) => {
          const correctAnswers = student.answers.filter(
            (a) => a.isCorrect
          ).length;
          const totalQuestions = currentAssessment.questionsCount;
          const score = (correctAnswers / totalQuestions) * 100;
          const studentCard = document.createElement("div");
          studentCard.className = "student-card";
          studentCard.innerHTML = `
          <h4>${student.studentName}</h4>
          <p>Acertos: ${correctAnswers}/${totalQuestions}</p>
          <p>Nota: ${score.toFixed(1)}%</p>
          <span class="status-badge ${
            score >= 60 ? "status-correct" : "status-wrong"
          }">
            ${score >= 60 ? "Aprovado" : "Reprovado"}</span>`;
          studentsList.appendChild(studentCard);
        });
      }
      function updateStudentCount() {
        const countMessage = currentAssessment
          ? `Alunos cadastrados: ${studentAnswers.length}/50`
          : "Crie uma avaliação para registrar alunos.";
        studentCount.textContent = countMessage;
        if (studentAnswers.length >= 50)
          studentCount.innerHTML +=
            " - <strong>Limite máximo atingido</strong>";
      }

      // === Limpeza
      async function handleClearData() {
        if (
          confirm(
            "Tem certeza que deseja apagar TODOS os dados? Esta ação não pode ser desfeita."
          )
        ) {
          try {
            const response = await authFetch("/clear-data", {
              method: "DELETE",
            });
            const result = await response.json();
            if (response.ok) {
              currentAssessment = null;
              answerKey = null;
              studentAnswers = [];
              onlineFormLink = "";
              alert("Todos os dados foram apagados.");
              updateDashboardCards();
              updateStatus();
              showSection("dashboard");
              document.getElementById("assessment-form").reset();
              questionsContainer.innerHTML = "";
              keyContainer.innerHTML = "";
              answersContainer.innerHTML = "";
              studentsList.innerHTML = "";
              formLinkContainer.style.display = "none";
              formPreviewContainer.innerHTML = "";
            } else {
              alert(`Erro: ${result.error || "Falha ao limpar dados"}`);
            }
          } catch (error) {
            alert("Erro ao conectar com o servidor.");
            console.error(error);
          }
        }
      }

      // === Relatórios / Gráficos
      function exportToPDF() {
        if (!currentAssessment || !answerKey || studentAnswers.length === 0) {
          alert("Não há dados de alunos para gerar um relatório.");
          return;
        }
        const reportElement = document.createElement("div");
        reportElement.style.padding = "20px";
        reportElement.style.backgroundColor = "white";
        reportElement.style.color = "black";
        reportElement.style.fontFamily = "Arial, sans-serif";
        reportElement.innerHTML = `
        <h1 style="text-align:center; color:#2c3e50">Relatório de Avaliação</h1>
        <h2 style="color:#2c3e50">${currentAssessment.name}</h2>
        <p><strong>Data:</strong> ${new Date().toLocaleDateString()}</p>
        <p><strong>Total de alunos:</strong> ${studentAnswers.length}</p>
        <p><strong>Total de questões:</strong> ${
          currentAssessment.questionsCount
        }</p>
        <h3 style="color:#2c3e50; margin-top:20px;">Desempenho Geral</h3>
        <div style="display:flex; gap:10px; margin:10px 0">
          <div style="flex:1; background:#f1f2f6; padding:10px; border-radius:6px"><h4>Média</h4><p style="font-size:22px;font-weight:bold">${calculateAverageScore().toFixed(
            1
          )}%</p></div>
          <div style="flex:1; background:#f1f2f6; padding:10px; border-radius:6px"><h4>Maior</h4><p style="font-size:22px;font-weight:bold">${calculateMaxScore().toFixed(
            1
          )}%</p></div>
          <div style="flex:1; background:#f1f2f6; padding:10px; border-radius:6px"><h4>Menor</h4><p style="font-size:22px;font-weight:bold">${calculateMinScore().toFixed(
            1
          )}%</p></div>
        </div>
        <h3 style="color:#2c3e50; margin-top:20px;">Top 5 Alunos</h3>
        <table style="width:100%; border-collapse:collapse; margin-top:10px">
          <thead><tr style="background:#2c3e50; color:#fff"><th style="padding:8px;text-align:left">Posição</th><th style="padding:8px;text-align:left">Aluno</th><th style="padding:8px;text-align:left">Nota</th><th style="padding:8px;text-align:left">Acertos</th></tr></thead>
          <tbody>
          ${getTopStudents(5)
            .map(
              (s, i) => `
            <tr style="border-bottom:1px solid #ddd">
              <td style="padding:8px">${i + 1}º</td>
              <td style="padding:8px">${s.studentName}</td>
              <td style="padding:8px">${s.score.toFixed(1)}%</td>
              <td style="padding:8px">${s.correctAnswers}/${
                currentAssessment.questionsCount
              }</td>
            </tr>`
            )
            .join("")}
          </tbody>
        </table>
        <h3 style="color:#2c3e50; margin-top:20px;">Desempenho por Questão</h3>
        <table style="width:100%; border-collapse:collapse; margin-top:10px">
          <thead><tr style="background:#2c3e50; color:#fff"><th style="padding:8px;text-align:left">Questão</th><th style="padding:8px;text-align:left">Assunto</th><th style="padding:8px;text-align:left">Taxa de Acerto</th></tr></thead>
          <tbody>
            ${calculateQuestionPerformance()
              .map(
                (q, i) => `
              <tr style="border-bottom:1px solid #ddd">
                <td style="padding:8px">${i + 1}</td>
                <td style="padding:8px">${q.subject}</td>
                <td style="padding:8px">${q.accuracy.toFixed(1)}%</td>
              </tr>`
              )
              .join("")}
          </tbody>
        </table>`;
        document.body.appendChild(reportElement);
        html2canvas(reportElement).then((canvas) => {
          const imgData = canvas.toDataURL("image/png");
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF("p", "mm", "a4");
          const imgWidth = 210,
            pageHeight = 295,
            imgHeight = (canvas.height * imgWidth) / canvas.width;
          let heightLeft = imgHeight,
            position = 0;
          pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
          while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
          }
          pdf.save(
            `relatorio-avaliacao-${currentAssessment.name
              .replace(/\s+/g, "-")
              .toLowerCase()}.pdf`
          );
          document.body.removeChild(reportElement);
        });
      }

      // (funções de cálculo e gráficos)
      function calculateAverageScore() {
        if (studentAnswers.length === 0) return 0;
        const total = studentAnswers.reduce(
          (s, st) =>
            s +
            (st.answers.filter((a) => a.isCorrect).length /
              currentAssessment.questionsCount) *
              100,
          0
        );
        return total / studentAnswers.length;
      }
      function calculateMaxScore() {
        if (studentAnswers.length === 0) return 0;
        return Math.max(
          ...studentAnswers.map(
            (st) =>
              (st.answers.filter((a) => a.isCorrect).length /
                currentAssessment.questionsCount) *
              100
          )
        );
      }
      function calculateMinScore() {
        if (studentAnswers.length === 0) return 0;
        return Math.min(
          ...studentAnswers.map(
            (st) =>
              (st.answers.filter((a) => a.isCorrect).length /
                currentAssessment.questionsCount) *
              100
          )
        );
      }
      function getTopStudents(limit) {
        return studentAnswers
          .map((st) => {
            const c = st.answers.filter((a) => a.isCorrect).length;
            return {
              studentName: st.studentName,
              correctAnswers: c,
              score: (c / currentAssessment.questionsCount) * 100,
            };
          })
          .sort((a, b) => b.score - a.score)
          .slice(0, limit);
      }
      function calculateQuestionPerformance() {
        return Array.from(
          { length: currentAssessment.questionsCount },
          (_, i) => {
            const qn = i + 1;
            const correctCount = studentAnswers.filter(
              (st) => st.answers.find((a) => a.questionNumber === qn)?.isCorrect
            ).length;
            const accuracy = (correctCount / studentAnswers.length) * 100;
            const subject = currentAssessment.questions.find(
              (q) => q.number === qn
            ).subject;
            return { questionNumber: qn, subject, accuracy };
          }
        );
      }

      function renderChart(canvasId, type, labels, data, options) {
        const ctx = document.getElementById(canvasId)?.getContext("2d");
        if (!ctx) return;
        let chartInstance;
        if (canvasId === "question-chart")
          chartInstance = questionChartInstance;
        if (canvasId === "subject-chart") chartInstance = subjectChartInstance;
        if (canvasId === "student-chart") chartInstance = studentChartInstance;

        if (chartInstance) {
          chartInstance.data.labels = labels;
          chartInstance.data.datasets[0].data = data;
          chartInstance.update();
        } else {
          const newChart = new Chart(ctx, {
            type,
            data: { labels, datasets: [{ data, ...options }] },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              ...options.options,
            },
          });
          if (canvasId === "question-chart") questionChartInstance = newChart;
          if (canvasId === "subject-chart") subjectChartInstance = newChart;
          if (canvasId === "student-chart") studentChartInstance = newChart;
        }
      }
      function renderQuestionChart() {
        if (!currentAssessment || studentAnswers.length === 0) {
          document.getElementById("question-tab").innerHTML =
            "<p>Não há dados suficientes para exibir o gráfico.</p>";
          return;
        }
        const perf = calculateQuestionPerformance();
        const labels = perf.map((q) => `Q${q.questionNumber}`);
        const data = perf.map((q) => q.accuracy);
        renderChart("question-chart", "bar", labels, data, {
          label: "Taxa de Acerto (%)",
          backgroundColor: "rgba(90,125,255,.7)",
          borderColor: "rgba(90,125,255,1)",
          borderWidth: 1,
          options: {
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: { display: true, text: "Percentual de Acertos" },
              },
            },
          },
        });
      }
      function renderSubjectChart() {
        if (!currentAssessment || studentAnswers.length === 0) {
          document.getElementById("subject-tab").innerHTML =
            "<p>Não há dados suficientes para exibir o gráfico.</p>";
          return;
        }
        const subjects = [
          ...new Set(currentAssessment.questions.map((q) => q.subject)),
        ];
        const perf = subjects.map((s) => {
          const arr = studentAnswers.flatMap((st) =>
            st.answers.filter((a) => a.subject === s)
          );
          const c = arr.filter((a) => a.isCorrect).length;
          return (c / studentAnswers.length) * 100;
        });
        renderChart("subject-chart", "bar", subjects, perf, {
          label: "Desempenho por Assunto (%)",
          backgroundColor: [
            "rgba(90,125,255,.7)",
            "rgba(23,195,178,.7)",
            "rgba(252,203,87,.7)",
            "rgba(255,107,107,.7)",
          ],
          borderColor: [
            "rgba(90,125,255,1)",
            "rgba(23,195,178,1)",
            "rgba(252,203,87,1)",
            "rgba(255,107,107,1)",
          ],
          borderWidth: 1,
          options: {
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: { display: true, text: "Percentual de Acertos" },
              },
            },
          },
        });
      }
      function renderStudentChart() {
        if (!currentAssessment || studentAnswers.length === 0) {
          document.getElementById("student-tab").innerHTML =
            "<p>Não há dados suficientes para exibir o gráfico.</p>";
          return;
        }
        const s = getTopStudents(studentAnswers.length);
        renderChart(
          "student-chart",
          "bar",
          s.map((x) => x.studentName),
          s.map((x) => x.score),
          {
            label: "Desempenho dos Alunos (%)",
            backgroundColor: "rgba(23,195,178,.7)",
            borderColor: "rgba(23,195,178,1)",
            borderWidth: 1,
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                  title: { display: true, text: "Percentual de Acertos" },
                },
              },
            },
          }
        );
      }
      function renderStudentDetails() {
        if (!currentAssessment || studentAnswers.length === 0) {
          studentDetails.innerHTML =
            "<p>Não há dados de alunos para exibir detalhes.</p>";
          return;
        }
        studentDetails.innerHTML = "<h3>Detalhes por Aluno</h3>";
        studentAnswers.forEach((student) => {
          const correct = student.answers.filter((a) => a.isCorrect).length;
          const score = (correct / currentAssessment.questionsCount) * 100;
          const d = document.createElement("div");
          d.className = "student-card";
          d.style.marginBottom = "20px";
          d.innerHTML = `<h4>${student.studentName} - Nota: ${score.toFixed(
            1
          )}%</h4><p>Acertos: ${correct}/${
            currentAssessment.questionsCount
          }</p><div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;"></div>`;
          const box = d.querySelector("div");
          for (let i = 1; i <= currentAssessment.questionsCount; i++) {
            const ans = student.answers.find((a) => a.questionNumber === i);
            const ok = ans?.isCorrect;
            const b = document.createElement("div");
            b.style.cssText =
              "width:30px; height:30px; border-radius:5px; display:flex; align-items:center; justify-content:center; font-size:.8rem;";
            b.style.background = ok
              ? "var(--success-color)"
              : "var(--danger-color)";
            b.textContent = i;
            box.appendChild(b);
          }
          studentDetails.appendChild(d);
        });
      }

      // Form online com token (e atualiza link do aluno)
      async function generateOnlineForm() {
        if (!currentAssessment) {
          alert("Crie uma avaliação.");
          return;
        }
        if (!answerKey) {
          alert("Defina o gabarito.");
          return;
        }
        const formTitle =
          document.getElementById("form-title").value || "Avaliação Online";
        const formDescription =
          document.getElementById("form-description").value ||
          "Preencha suas respostas.";
        const requireName =
          document.getElementById("form-require-name").value === "yes";

        try {
          const resp = await authFetch("/forms", {
            method: "POST",
            body: JSON.stringify({
              assessmentId: currentAssessment._id,
              title: formTitle,
              description: formDescription,
              requireName,
            }),
          });
          const data = await resp.json();
          if (!resp.ok) {
            alert(
              `Erro ao criar formulário: ${data?.error || "Falha inesperada"}`
            );
            return;
          }

          onlineFormLink = data.url;
          formLink.value = onlineFormLink;
          formLinkContainer.style.display = "block";
          paintApp();

          renderFormPreview({
            title: formTitle,
            description: formDescription,
            requireName,
          });
          alert("Formulário online criado! Compartilhe o link com os alunos.");
        } catch (e) {
          console.error(e);
          alert("Erro ao conectar com o servidor.");
        }
      }
      function renderFormPreview(formData) {
        if (!currentAssessment) return;
        formPreviewContainer.innerHTML = `
        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px;">
          <h2>${formData.title}</h2>
          <p>${formData.description || ""}</p>
          ${
            formData.requireName
              ? `
            <div class="form-group"><label>Nome do Aluno</label><input type="text" placeholder="Digite seu nome completo" /></div>
          `
              : `<p><em>Este formulário não exige nome.</em></p>`
          }
          <div class="form-preview-questions">
            ${currentAssessment.questions
              .map(
                (q) => `
              <div class="question-preview">
                <h4>Questão ${q.number} - ${q.subject}</h4>
                <p>Selecione a alternativa:</p>
                <div class="options-container">
                  ${["A", "B", "C", "D", "E"]
                    .map(
                      (l) => `
                    <div class="option-item"><input type="radio" disabled name="question-${q.number}" value="${l}"><label>${l}</label></div>
                  `
                    )
                    .join("")}
                </div>
              </div>`
              )
              .join("")}
          </div>
          <p style="margin-top:12px">Página pública: <a href="${onlineFormLink}" target="_blank">${onlineFormLink}</a></p>
        </div>`;
      }
      async function copyFormLink() {
        try {
          if (!onlineFormLink) return;
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(onlineFormLink);
          } else {
            formLink.select();
            document.execCommand("copy");
          }
          alert("Link copiado!");
        } catch {
          alert("Não foi possível copiar o link.");
        }
      }
    </script>
  </body>
</html>
